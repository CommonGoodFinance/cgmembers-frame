<?php
/**
 * @file
 * rCredits Web Interface
 *
 * An interface module for the rCredits financial system.
 *
 * Note: to display one of the blocks defined herein on a page, use
 * echo render(rweb_block_view('blockname'));)
 */

use \rCredits\Web as rWeb;
use \rCredits\API as i;
use \rCredits\Utilities as u;

require_once __DIR__ . '/../rcredits.inc';
require_once __DIR__ . '/rweb.inc';

//define('RWEB_BLOCKS', 'account payment buy_now example_store charge exchange manage tx_period txs manage_account');
define('RWEB_BLOCKS', 'account');

/**
 * Implements hook_block_info().
 * NOTE: specifying a region fails, so you have to do that in block administration (show the 'account' block in Header)
 */
function rweb_block_info() {
  $info = array();
  foreach (u\ray(RWEB_BLOCKS) as $one) {
    $def = array('info' => ucfirst($one) . ' Block');
    if ($one == 'account') $def += array('region' => 'header', 'visibility' => BLOCK_VISIBILITY_LISTED, 'pages' => "members\nmembers/*");
    $info[$one] = $def;
  }
  return $info;
}

function rweb_block_view($delta = '') {
  if (!in_array($delta, u\ray(RWEB_BLOCKS))) return;
  return rWeb\block_view(NULL, drupal_get_form("rCredits\\Web\\{$delta}_form")); // no subject for blocks
}

/**
 * Implements hook_menu().
 */
function rweb_menu() {
  $anyone = array('access callback' => TRUE, 'access arguments' => NULL);
  $can_create = i\access('can create transactions');
  $menu = array(
    'handy' => rWeb\menu('Handy Links', MENU_NORMAL_ITEM, 'handy_links', array(), 'administer site configuration'),
//    'members' => rWeb\menu($can_create ? 'Members Section' : 'Transactions', MENU_NORMAL_ITEM, 'show_form', array($can_create ? 'tx' : 'txs', 2)),
    'members' => rWeb\menu('Members Section', MENU_NORMAL_ITEM, 'show_form', array($can_create ? 'tx' : 'txs', 2)),
    'members/transact' => rWeb\menu('Pay / Charge', MENU_DEFAULT_LOCAL_TASK, NULL, array('tx', 2), 'can create transactions'),
    'members/contact-info' => rWeb\menu('Contact Info', MENU_LOCAL_TASK, 'show_form', array('contact_info'), 'can manage account'),
    'members/cell-access' => rWeb\menu('Cell Access', MENU_LOCAL_TASK, 'show_form', array('cell'), 'can manage account'),
    'members/sharing' => rWeb\menu('Sharing', MENU_LOCAL_TASK, 'show_form', array('share'), 'can manage account'),
    'members/transactions' => rWeb\menu('Transactions', MENU_LOCAL_TASK, 'show_form', array('txs',2), 'can read transactions'),
    'members/exchange' => rWeb\menu('Get rCredits / USD', MENU_LOCAL_TASK, 'show_form', array('exchange'), 'can create transactions'),
    'members/directory' => rWeb\menu('Directory', MENU_LOCAL_TASK, 'show_form', array('directory'), 'can create transactions'),
    'example-store' => rWeb\menu('Example Store', MENU_NORMAL_ITEM, 'show_form', array('example_store'), '', $anyone),
    'members/pay-with-rcredits' => rWeb\menu('Pay With rCredits', 0, 'show_form', array('buy_now'), '', $anyone), // form will require login
    'rCredits/util' => rWeb\menu('Util', 0, 'rCredits\\Web\\util', array(2), 'administer site configuration'),
  );
  return $menu;
}

function rweb_form_user_register_form_alter(&$form, &$form_state, $form_id) {rWeb\register_form($form, $form_state);}
function rweb_form_user_login_block_alter(&$form, &$form_state, $form_id) {return rWeb\login_form($form, $form_state);}
function rweb_form_user_login_form_alter(&$form, &$form_state, $form_id) {return rWeb\login_form($form, $form_state);}

