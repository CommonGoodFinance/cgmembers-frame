<?php
/**
 * @file
 * rCredits Web Interface
 *
 * An interface module for the rCredits financial system.
 *
 * Note: to display one of the blocks defined herein on a page, use
 * print render(rweb_block_view('blockname'));)
 */

use rCredits as r;
use rCredits\Backend as be;
use rCredits\Util as u;
use rCredits\Web as w;

require_once __DIR__ . '/../rcredits.inc';
require_once __DIR__ . '/rweb.inc';

define('RWEB_BLOCKS', 'accounts footer');

/**
 * Implements hook_block_info().
 */
function rweb_block_info() {
  $info = [];
  foreach (u\ray(RWEB_BLOCKS) as $one) {
    $def = array('info' => ucfirst($one) . ' Block');
    $status = 1;
    $def += compact(u\ray('region status'));
    $info[$one] = $def;
  }
  $info['footer']['cache'] = -1;
  $info['footer']['region'] = 'footer';
  $info['accounts']['region'] = 'accounts';
  return $info;
}

/**
 * Implements hook_block_view().
 */
function rweb_block_view($delta = '') {
  if (in_array($delta, u\ray(RWEB_BLOCKS))) return r\Web\blockView(NULL, r\Web\showForm($delta)); // no subject for blocks
}

function makeMenuItem($parts) {
  $types = ['norm' => MENU_NORMAL_ITEM, 'sub' => MENU_LOCAL_TASK, 'dft' => MENU_DEFAULT_LOCAL_TASK, 'call' => MENU_CALLBACK];
  @list ($type, $title, $args, $perms, $func) = $parts;
  return r\Web\menu($title, $types[$type], $func ?: 'showForm', $args, $perms);
}

/**
 * Implements hook_menu().
MENU_CALLBACK  Menu type -- A hidden, internal callback, typically used for API calls.
MENU_DEFAULT_LOCAL_TASK  Menu type -- The "default" local task, which is initially active.
MENU_LOCAL_ACTION  Menu type -- An action specific to the parent, usually rendered as a link.
MENU_LOCAL_TASK  Menu type -- A task specific to the parent item, usually rendered as a tab.
MENU_NORMAL_ITEM  Menu type -- A "normal" menu item that's shown in menu and breadcrumbs.
MENU_SUGGESTED_ITEM  Menu type -- A normal menu item, hidden until enabled by an administrator.
 * @param string $submenu: (optional) a subsection of the menu structure to return RAW (unprocessed)
 */
function rweb_menu($submenu = '') {

  $items = array(
    'summary' => ['norm', t('Summary'), 'Summary', 'read'],

    'charge' => ['norm', t('Charge'), 'Tx 1', 'sell ok'],
    'pay' => ['norm', t('Pay'), 'Tx 1', 'buy ok confirmed'],
    'pay/one' => ['sub', t('Pay One'), 'Tx', 'co buy ok'],
    'pay/payroll' => ['sub', t('Upload Payroll'), 'Payroll', 'co buy ok'],
    'pay/zot' => ['sub', 'zot', '', ANY], // Drupal bug: last choice is omitted

    'grant' => ['norm', t('Grant'), 'Tx', 'managing_ctty'],
    'loan' => ['norm', t('Loan'), 'Tx', 'managing_ctty'],
    'invest' => ['norm', t('Invest'), 'Tx', 'managing_ctty'],
    'fine' => ['norm', t('Fine'), 'Tx', 'managing_ctty'],

    'get' => ['norm', t('Bank'), 'Get 1', 'manage bank ok'],

    'history' => ['norm', t('History'), 'History', 'read member'],
    'history/transactions' => ['sub', t('Transactions'), 'Txs 2', 'read', '', t(''), 'list'],
    'history/invoices-to' => ['sub', t('Invoices TO You'), 'Invoices to', 'read', '', t(''), 'log-in'],
    'history/invoices-from' => ['sub', t('Invoices FROM You'), 'Invoices from', 'read', '', t(''), 'log-out'],
    'history/statements' => ['sub', t('Statements'), 'Statements 2', 'read', '', t(''), 'list-alt'],
    'history/notices' => ['sub', t('Notices'), 'Notices 2', 'read', '', t(''), 'envelope'],
    'history/tax-info' => ['sub', t('Tax Info'), 'TaxInfo', 'read', '', t(''), 'pawn'],
    'history/changes' => ['sub', t('See Changes'), 'SeeChanges', 'cadmin', '', t(''), 'refresh'],
    'history/zot' => ['sub', 'zot', '', ANY], // Drupal bug: last choice is omitted
    'history/statement' => ['call', t('Statement'), '2', 'read', 'statement'],
//    'history/notice' => ['call', t('Notice'), 'Notice 2', 'read'],
    
//    'community' => ['norm', t('Community'), 'FindCo', ANY],
    'proposal' => ['call', t('Funding Proposal'), 'Proposal', ANY], // keep the url short, for outsiders
    'community' => ['norm', t('Community'), 'Community', ANY],
    'community/democracy' => ['sub', t('Discussion & Voting'), 'Democracy 2', 'ok manage', '', t(''), 'bell'],
    'community/agreement' => ['sub', t('The Agreement'), 'Agreement', ANY, '', t(''), 'globe'],
    'community/invite' => ['sub', t('Invite Someone'), 'Invite', 'member manage', '', t(''), 'share-alt'],
    'community/message' => ['sub', t('Message a Member'), 'Message', 'member manage', '', t(''), 'envelope'],
    'community/find-company' => ['sub', t('Find a Company'), 'FindCo', ANY, '', t(''), 'search'],
    'community/donate' => ['sub', t('Donate'), 'Donate', 'manage', '', t(''), 'thumbs-up'],
    'community/grant' => ['sub', t('Get Paid to Organize'), 'Grant', ANY, '', t(''), 'apple'],
    'community/funds' => ['sub', t('Funds in Each Community'), 'CttyFunds', ANY, '', t(''), 'usd'],
    'community/graphs' => ['sub', t('rCredits Economy Graphs'), 'Graphs 2', ANY, '', t(''), 'stats'],
    'community/flags' => ['sub', t('Risk Flags'), 'Flags 2', ANY, '', t(''), 'flag'],
//    'community/game' => isGAME ? ['sub', t('Game'), 'Game', ANY) : NULL,
    'community/zot' => ['sub', 'zot', '', ANY], // Drupal bug: last choice is omitted
    'community/invite/print' => ['call', t('Print Invite'), '', 'manage', 'printInvite'],
    'community/invite/invited-whom' => ['call', 'Invited Whom', 'InvitedWhom', 'manage'],
    'community/invite/waiting' => ['call', 'Waiting', 'Waiting', 'manage'],
    
    'settings' => ['norm', t('Settings'), 'Settings', 'manage -closed'],
//    'settings/settings' => ['dft', t('Settings'), 'Settings', 'manage'],
    'settings/contact' => ['sub', t('Contact Info'), 'Contact', 'manage', '', t(''), 'user'],
    'settings/preferences' => ['sub', t('Preferences'), 'Prefs', 'manage', '', t(''), 'cog'],
    'settings/security' => ['sub', t('Security'), 'Security 2', 'manage -co', '', t(''), 'link'],
    'settings/connect' => ['sub', t('Bank Info'), 'Connect 2', 'manage', '', t(''), 'piggy-bank'],
    'settings/company' => ['sub', t('Company Info'), 'Company 2', 'manage co', '', t(''), 'calendar'],
    'settings/relations' => ['sub', t('Relations'), 'Relations', 'manage', '', t(''), 'magnet'],
// DISABLE FOR NOW    'settings/boxes' => ['sub', t('Devices'), 'Boxes', 'manage', '', t(''), 'phone'],
    'settings/proxies' => ['sub', t('Proxies'), 'Proxies', 'manage -co', '', t(''), 'thumbs-up'],
    'settings/zot' => ['sub', 'zot', '', ANY], // Drupal bug: last choice is omitted

    'reset' => ['call', t('Choose New Password'), 'ResetPassword 1', ANY],
    'settings/notifications' => ['call', t('Notifications'), 'Notifications', 'manage'],
    'settings/ssn' => ['call', t('Correct SSN'), 'Ssn 2', 'manage'],
    'settings/password' => ['call', t('Request New Password'), 'Pass 2', ANY],
    'settings/security/change-password' => ['call', 'Change Password', 'ChangePassword', 'manage'],
    'settings/security/change-pin' => ['call', 'Change PIN', 'ChangePin', 'manage'],
    'settings/member-photo' => ['call', 'Member Photo', '2 3', ANY, 'memberPhoto'],
    'settings/security/photo' => ['call', 'Photo', 'Photo 3', 'manage'],
    'settings/security/photo/upload' => ['call', 'Photo Upload', '4 5', ANY, 'photoUpload'],
    'settings/icon' => ['call', 'Icon', 'Icon', 'read'],
//    'settings/verify-phone' => ['call', 'Verify Phone', 'VerifyPhone', 'manage dw'],
//    'settings/readd-phone' => ['call', 'reAdd Phone', '', 'manage dw', 'addPhone'],
    'settings/basic' => ['call', 'Basic', 'Basic', 'manage'],
//    'settings/kba' => ['call', 'Kba', 'Kba', 'manage dw'],
//    'settings/security/photo-id' => ['call', 'Kba', 'PhotoId', 'manage'],
    'settings/proxy' => ['call', 'Proxy', 'Proxy 2', 'manage'],
    'settings/verify' => ['call', 'Verify Email', 'Verify 1', 'manage'],
    'settings/resend' => ['call', 'Resend Email', 'Resend', 'manage'],

//    'handy' => isDEV ? ['norm', t('Handy'), '', 'dev', 'handyLinks'] : NULL,
    'tests' => isDEV ? ['norm', t('Test'), '1', isDEV ? 'dev' : NULL, 'test'] : NULL,
//    'php' => isDEV ? ['norm', t('PHP'), 'Php', 'dev'] : NULL,
    
    'menu' => ['call', t('Menu'), 'Menu', ANY],
    'empty' => ['call', t('Empty'), 'Empty 1', ANY],
    'prox' => ['call', t('Prox'), 'Prox 1 2', ANY], // proxy form called from rdo()

    'request-employee-rcard' => ['call', t('Request Employee rCard'), 'RequestRCard 1', 'manage'],
    
    'I' => ['call', 'Scanned QR', 'I', ANY],
    
    'signup-company' => ['call', t('Open a Company Account'), 'SignupCo', 'manage'],
    'handle-invoice' => ['call', t('Handle Invoice'), 'HandleInvoice 1', ANY],
    'rerisk' => ['call', t('Recalculate Risk'), 'Rerisk 1 2 3', 'regulator'],

    'sadmin' => ['norm', t('Admin'), 'Admin', 'cadmin2'],
    'sadmin/panel' => ['sub', t('Panel'), 'AdminPanel 2', 'cadmin'],
    'sadmin/member-list' => ['sub', t('Member List'), 'MemberList', 'cadmin2'],
    'sadmin/export-list' => ['sub', t('Export'), 'DownloadMemberList 2', 'cadmin2'],
    'sadmin/deposits' => ['sub', t('Deposits'), 'Deposits', 'admin'],
    'sadmin/new-member' => ['sub', t('New Member'), 'Signup code=.(admin)', 'cadmin'],
    'sadmin/make-community' => ['sub', t('Make Ctty'), 'MakeCtty', 'admin'],
    'sadmin/sms' => ['sub', t('Test SMS'), 'SMS', 'admin'],
    'sadmin/handy' => ['sub', t('Handy'), '', 'dev', 'handyLinks'],
    'sadmin/php' => ['sub', t('PHP'), 'Php', 'dev'],
    'sadmin/zot' => ['sub', 'zot', '', 'admin'], // Drupal bug: last choice is omitted
//    'sadmin/acct-info' => ['call', 'Account Info', 'Summary 2', 'regulator'],
    'sadmin/tx-info' => ['call', 'Transaction Info', 'TxInfo 2', 'regulator'],
    'sadmin/deposit-details' => ['call', t('Deposit Details'), '2', 'admin', 'depositDetails'],
    'sadmin/checks' => ['call', t('Checks'), '2', 'admin', 'printChecks'],
    'sadmin/changes' => ['call', t('See Changes'), 'SeeChanges 2', 'cadmin'],
    'sadmin/organizer-list' => ['call', t('Organizer List'), 'OrganizerList 2', 'admin'],
    'rcredits/util' => ['call', 'Util', '2', 'admin', 'util'],
    'sadmin/recover' => ['call', t('Empty'), 'TestRecovery 1', 'dev'], // also go here manually, if needed
    'print-rcard' => ['call', t('Print ID Card'), '1 2', 'cadmin', 'memberID'],

    'signout' => ['norm', t('Sign out'), '1', 'signedIn', 'signout'],
    'signin' => ['norm', t('Sign in'), 'Signin', 'signedOut'],
//    'signin' => ['call', 'Sign in', 'Signin', ANY],
//    'sinx' => ['call', 'Sign in from elsewhere', 'Sinx', ANY],
    
    'help' => ['call', t('Help'), 'Help 1 2', ANY],
    'change-account' => ['call', t('Change Who'), '1', ANY, 'changeWho'],
    'status' => ['call', 'Status', 'Membership 1', 'manage'],
    'signup' => ['call', t('Sign Up For rCredits'), 'Signup', ANY],
    'menu' => ['call', 'Main Menu', 'Menu', ANY],
    'member' => ['call', 'Company Profile', 'Profile', ANY],
    'autocomplete' => ['call', 'Identify', '1 2 3', ANY, 'auto'],
    'do' => ['call', 'Do', '1 2', ANY, 'rdo'],
    'coup' => ['call', t('Disable account'), '1', ANY, 'coup'],

//    'savings' => ['call', t('Savings'), 'ChooseSavings', ANY], // temporary until 12/15/2015 or so
    'accept' => ['call', 'Accept Invitation', 'Accept 1', ANY], // called from promo site rCredits.org
    'pos' => ['call', 'POS', '', ANY, 'rCredits\\Smart\\pos'], // called from the rPOS app
    'ajax' => ['call', 'AJAX', '1', ANY, 'ajax'], // called from the rPOS app
    'whosin' => ['call', t('Who\'s in?'), '1', ANY, 'whosin'], // called from promo site
    'secret' => ['call', 'Secret', '', ANY, 'secrets'],
    'error' => ['call', 'System Error', '1', ANY, 'error'],
    'page-not-found' => ['call', t('Page Not Found'), 'PageNotFound', ANY],
    
    'pay-with-rcredits' => ['call', 'Pay With rCredits', 'Buy', ANY], // form will require PIN
  );
// $menu['user/password'] = $menu['settings/password']; // duplicates user/password (handles built-in Drupal link)

  if ($submenu) {
    foreach ($items as $k => $v) if (@$v and u\starts($k, "$submenu/")) $menu[$k] = $v;
  } else foreach ($items as $k => $v) if (@$v) $menu[$k] = makeMenuItem($v);

  return $menu;
}

function rweb_menu_alter(&$items) {
  foreach (u\ray('node user/password user/register') as $one) unset($items[$one]);
}

function rweb_form_alter(&$form, &$sta, $form_id) {
  global $base_url;
  $req = basename($_SERVER['REQUEST_URI']);
///  debug(compact('req','form_id'));
  if (!\user_is_logged_in() and in_array($req, ['login', 'logout'])) {
    $home = isGAME ? 'community/game' : 'signin';
    header("location:$base_url/$home"); // nothing else works
    exit();
  }
/*  if ($req == 'login' and !user_is_logged_in()) {header("location:$base_url/" . (isGAME ? 'community/game' : 'signin')); exit();} // nothing else works
  if ($req == 'logout' and !user_is_logged_in()) {header('location:' . (isGAME ? "$base_url/community/game" : (isDEV ? 'http://localhost' . DEV_ROOT : BASE_URL) . '/signin')); exit();} // nothing else works */
  if ($req == 'user' and user_is_logged_in()) r\go(isGAME ? 'community/game' : 'summary'); // summary not ''
  $form['opid'] = w\hidFld('none', ['name' => 'opid']);
}

//function rweb_form_user_register_form_alter(&$form, &$sta, $form_id) {r\Web\formRegister($form, $sta);}
//function rweb_form_user_login_block_alter(&$form, &$sta, $form_id) {return r\Web\formLogin($form, $sta, FALSE);}
// (has no effect, keep as comment) function rweb_form_user_login_form_alter(&$form, &$sta, $form_id) {return r\Web\formLogin($form, $sta);}
//function rweb_user_login(&$edit, $account) {r\Web\loginFollowup($edit, $account->uid);}
//function rweb_form_user_pass_alter(&$form, &$sta) {return r\Web\passAlter($form, $sta);}

/*function rweb_form_user_profile_form_alter(&$form, &$sta, $form_id) {
  $form['account']['pass']['#process'] = array('expand_password_confirm', 'yourmodule_password_confirm');
}*/
