<?php
/**
 * @file
 * rCredits Web Interface
 *
 * An interface module for the rCredits financial system.
 *
 * Note: to display one of the blocks defined herein on a page, use
 * echo render(rweb_block_view('blockname'));)
 */

use rCredits as r;
use rCredits\Backend as be;
use rCredits\Util as u;

require_once __DIR__ . '/../rcredits.inc';
require_once __DIR__ . '/rweb.inc';
require_once __DIR__ . '/../rsmart/rsmart.inc'; // for smart api menu entry

//define('RWEB_BLOCKS', 'accounts payment buy_now example_store charge exchange manage tx_period txs manage_account');
define('RWEB_BLOCKS', 'accounts');

/**
 * Implements hook_block_info().
 */
function rweb_block_info() {
  $info = array();
  foreach (u\ray(RWEB_BLOCKS) as $one) {
    $def = array('info' => ucfirst($one) . ' Block');
    if ($one == 'accounts') {
      $region = 'header';
//      $visibility = BLOCK_VISIBILITY_LISTED;
//      $pages = "members\nmembers/*";
      $status = 1;
      $def += compact(u\ray('region status'));
    }
    $info[$one] = $def;
  }
  return $info;
}

/**
 * Implements hook_block_view().
 */
function rweb_block_view($delta = '') {
  if (in_array($delta, u\ray(RWEB_BLOCKS))) return r\Web\blockView(NULL, r\Web\showForm($delta)); // no subject for blocks
}

/**
 * Implements hook_menu().
 MENU_CALLBACK	Menu type -- A hidden, internal callback, typically used for API calls.
MENU_DEFAULT_LOCAL_TASK	Menu type -- The "default" local task, which is initially active.
MENU_LOCAL_ACTION	Menu type -- An action specific to the parent, usually rendered as a link.
MENU_LOCAL_TASK	Menu type -- A task specific to the parent item, usually rendered as a tab.
MENU_NORMAL_ITEM	Menu type -- A "normal" menu item that's shown in menu and breadcrumbs.
MENU_SUGGESTED_ITEM	Menu type -- A normal menu item, hidden until enabled by an administrator.
 */
function rweb_menu() {
  $anyone = array('access callback' => TRUE, 'access arguments' => NULL);
  $smart = array('module' => 'rsmart', 'file' => 'rsmart.inc');
  $modal = array('modal' => TRUE);
  
  $menu = array(
    'help' => r\Web\menu(t('Help'), MENU_CALLBACK, 'showForm', array('Help', 1), '', $anyone),
    'summary' => r\Web\menu(t('Summary'), MENU_NORMAL_ITEM, 'showForm', array('Summary'), '', $anyone),
    'transactions' => r\Web\menu(t('Transactions'), MENU_NORMAL_ITEM, 'showForm', array('Txs', 1), 'read transactions'),
    'charge' => r\Web\menu(t('Charge'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'sell'),
    'pay' => r\Web\menu(t('Pay'), MENU_NORMAL_ITEM, 'showForm', array('Tx', 1), 'buy and sell'),
    'exchange' => r\Web\menu(t('Get rCredits / USD'), MENU_NORMAL_ITEM, 'showForm', array('Exchange'), 'manage account'),
    'directory' => r\Web\menu(t('Find Companies'), MENU_NORMAL_ITEM, 'showForm', array('Directory'), 'sell'),
    'Temporary-Member-ID-Card' => r\Web\menu(t('Print Temporary Member ID Card'), MENU_CALLBACK, 'memberID', array(1),  'sell'),
    'draft' => r\Web\menu(t('Draft into Database'), MENU_CALLBACK, 'showForm', array('Draft', 1), 'sell'),
    
    'I' => r\Web\menu('Scanned QR', MENU_CALLBACK, 'showForm', array('I'), '', $anyone),
    'sms' => r\Web\menu('Test SMS', MENU_CALLBACK, 'showForm', array('SMS'), '', $anyone), // should be 'admin' not '',...
    'handy' => r\Web\menu('Handy Links', MENU_NORMAL_ITEM, 'handy_links', array(), 'admin'),

    'account' => r\Web\menu(t('Basic Account Settings'), MENU_CALLBACK, 'showForm', array('Account'), 'manage account'),
    'account/overview' => r\Web\menu('Basic Account Settings', MENU_DEFAULT_LOCAL_TASK, 'showForm', array('Account'), 'manage account'),
    'account/cell' => r\Web\menu(t('Cell Phone Access'), MENU_LOCAL_TASK, 'showForm', array('Cell'), 'manage account'),
    'account/relations' => r\Web\menu(t('Relations'), MENU_LOCAL_TASK, 'showForm', array('Relations'), 'manage account'),
    'account/contact' => r\Web\menu(t('Contact Information'), MENU_LOCAL_TASK, 'showForm', array('Contact'), 'manage account'),
    'account/company' => r\Web\menu(t('Company Info'), MENU_LOCAL_TASK, 'showForm', array('Company'), 'company'),
    'account/options' => r\Web\menu(t('Account Options'), MENU_LOCAL_TASK, 'showForm', array('Options'), 'manage account'),
//    'account/bank-info' => r\Web\menu(t('Bank Info'), MENU_LOCAL_TASK, 'showForm', array('Bank'), 'manage account'),

    'radmin' => r\Web\menu(t('Community Overview'), MENU_CALLBACK, 'showForm', array('Account'), 'community admin'),
    'radmin/overview' => r\Web\menu('Community Overview', MENU_DEFAULT_LOCAL_TASK, 'showForm', array('Account'), 'community admin'),
    'radmin/grant' => r\Web\menu(t('Grant'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'community admin'),
    'radmin/loan' => r\Web\menu(t('Loan'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'community admin'),
    'radmin/fine' => r\Web\menu(t('Fine'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'community admin'),

    'membership' => r\Web\menu(t('Membership Status'), MENU_CALLBACK, 'showForm', array('Membership'), 'manage account'),

    'member' => r\Web\menu('Company Profile', MENU_CALLBACK, 'showForm', array('Profile'), '', $anyone),
    'rcredits/util' => r\Web\menu('Util', MENU_CALLBACK, 'rCredits\\Web\\util', array(2), 'admin'),
    'autocomplete' => r\Web\menu('Identify', MENU_CALLBACK, 'rCredits\\Web\\auto', array(1, 2, 3), '', $anyone),

    'rcredits/backend' => r\Web\menu('API', 0, 'rCredits\\be\\backend2', array(), '', $anyone),
    'api' => r\Web\menu('API', 0, 'rCredits\\Smart\\api', array(), '', $anyone),
    'error' => r\Web\menu('System Error', 0, 'rCredits\\error', array(1), '', $anyone),
    
    'pay-with-rcredits' => r\Web\menu('Pay With rCredits', MENU_CALLBACK, 'showForm', array('Buy'), '', $anyone), // form will require login

//    'example-store' => r\Web\menu('Example Store', MENU_NORMAL_ITEM, 'showForm', array('example_store'), '', $anyone),
//    'modal' => r\Web\menu('Modal Test', MENU_CALLBACK, 'drupal_get_form', array('rCredits\\Web\\modal_form'), '', $anyone + $modal),
//    'ok' => r\Web\menu('Please Confirm', MENU_CALLBACK, 'showForm', array('ok'), '', $anyone + $modal),
  );
  return $menu;
}

function rweb_menu_alter(&$items) {
  unset($items['node']);
}

function rweb_form_alter(&$form, &$sta, $form_id) {
//debug($form);
//debug($sta);
//debug($form_id);
//debug($_SERVER);
  if ($form_id == 'user_pass_reset') return r\Web\resetAlter($form, $sta);
  if ($form_id == 'user_login') return r\Web\loginAlter($form, $sta);
  if (basename($_SERVER['REQUEST_URI']) == 'user' and user_is_logged_in()) r\go('');
}

function rweb_form_user_register_form_alter(&$form, &$sta, $form_id) {r\Web\formRegister($form, $sta);}
function rweb_form_user_login_block_alter(&$form, &$sta, $form_id) {return r\Web\loginAlter($form, $sta, FALSE);}
function rweb_form_user_login_form_alter(&$form, &$sta, $form_id) {return r\Web\loginAlter($form, $sta);}
function rweb_user_login(&$edit, $account) {r\Web\loginFollowup($edit, $account);} // Implements hook_user_login().
function rweb_form_user_pass_alter(&$form, &$sta) {return r\Web\passAlter($form, $sta);}

/*function rweb_form_user_profile_form_alter(&$form, &$sta, $form_id) {
  $form['account']['pass']['#process'] = array('expand_password_confirm', 'yourmodule_password_confirm');
}*/
