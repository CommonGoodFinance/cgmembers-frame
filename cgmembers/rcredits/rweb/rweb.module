<?php
/**
 * @file
 * rCredits Web Interface
 *
 * An interface module for the rCredits financial system.
 *
 * Note: to display one of the blocks defined herein on a page, use
 * echo render(rweb_block_view('blockname'));)
 */

use rCredits as r;
use rCredits\Backend as be;
use rCredits\Util as u;

require_once __DIR__ . '/../rcredits.inc';
require_once __DIR__ . '/rweb.inc';
//require_once __DIR__ . '/../rsmart/rsmart.inc'; // for smart api menu entry

define('RWEB_BLOCKS', 'accounts footer');

/**
 * Implements hook_block_info().
 */
function rweb_block_info() {
  $info = array();
  foreach (u\ray(RWEB_BLOCKS) as $one) {
    $def = array('info' => ucfirst($one) . ' Block');
    $status = 1;
    $def += compact(u\ray('region status'));
    $info[$one] = $def;
  }
  $info['footer']['cache'] = -1;
  $info['footer']['region'] = 'footer';
  $info['accounts']['region'] = 'accounts';
  return $info;
}

/**
 * Implements hook_block_view().
 */
function rweb_block_view($delta = '') {
  if (in_array($delta, u\ray(RWEB_BLOCKS))) return r\Web\blockView(NULL, r\Web\showForm($delta)); // no subject for blocks
}

/**
 * Implements hook_menu().
 MENU_CALLBACK	Menu type -- A hidden, internal callback, typically used for API calls.
MENU_DEFAULT_LOCAL_TASK	Menu type -- The "default" local task, which is initially active.
MENU_LOCAL_ACTION	Menu type -- An action specific to the parent, usually rendered as a link.
MENU_LOCAL_TASK	Menu type -- A task specific to the parent item, usually rendered as a tab.
MENU_NORMAL_ITEM	Menu type -- A "normal" menu item that's shown in menu and breadcrumbs.
MENU_SUGGESTED_ITEM	Menu type -- A normal menu item, hidden until enabled by an administrator.
 */
function rweb_menu() {
  $anyone = array('access callback' => TRUE, 'access arguments' => NULL);
  $smart = array('module' => 'rsmart', 'file' => 'rsmart.inc');
  $modal = array('modal' => TRUE);
  
  $menu = array(
    'help' => r\Web\menu(t('Help'), MENU_CALLBACK, 'showForm', array('Help', 1), '', $anyone),
    'summary' => r\Web\menu(t('Summary'), MENU_NORMAL_ITEM, 'showForm', array('Summary'), '', $anyone),
    'transactions' => r\Web\menu(t('Transactions'), MENU_NORMAL_ITEM, 'showForm', array('Txs', 1), 'read'),
    'charge' => r\Web\menu(t('Charge'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'sell_ok'),
    'pay' => r\Web\menu(t('Pay'), MENU_NORMAL_ITEM, 'showForm', array('Tx', 1), 'buy_ok'),

    'grant' => r\Web\menu(t('Grant'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'managing_ctty'),
    'loan' => r\Web\menu(t('Loan'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'managing_ctty'),
    'fine' => r\Web\menu(t('Fine'), MENU_NORMAL_ITEM, 'showForm', array('Tx'), 'managing_ctty'),

//    'getr' => r\Web\menu(t('Get rCredits'), MENU_NORMAL_ITEM, 'showForm', array('GetR'), 'manage'),
    'directory' => r\Web\menu(t('Find Companies'), MENU_NORMAL_ITEM, 'showForm', array('Directory'), 'sell'),
    'reports' => r\Web\menu(t('Reports'), MENU_NORMAL_ITEM, 'showForm', array('Reports', 1), '', $anyone),
    'invite' => r\Web\menu(t('Invite'), MENU_LOCAL_TASK, 'showForm', array('Invite'), 'manage'),
    'undo' => r\Web\menu(t('Undo'), MENU_CALLBACK, 'undo', array(1), 'sell'),
    'remainder' => r\Web\menu(t('Show Customer Balance'), MENU_CALLBACK, 'remainder', array(1), 'sell'),
    'empty' => r\Web\menu(t('Empty'), MENU_CALLBACK, 'showForm', array('Empty'), '', $anyone),

    'print-rcard' => r\Web\menu(t('Print ID Card'), MENU_CALLBACK, 'memberID', array(1), 'admin'),
    'reinstall' => r\Web\menu(t('Reinstall rCredits'), MENU_CALLBACK, 'reinstall', array(), 'admin'),

    'request-employee-rcard' => r\Web\menu(t('Request Employee rCard'), MENU_CALLBACK, 'showForm', array('RequestRCard', 1), 'manage'),
//    'draft' => r\Web\menu(t('Draft into Database'), MENU_CALLBACK, 'showForm', array('Draft', 1), 'sell'),
    
    'I' => r\Web\menu('Scanned QR', MENU_CALLBACK, 'showForm', array('I'), '', $anyone),
    'change-account' => r\Web\menu('Change Account', MENU_CALLBACK, 'changeAccount', array(1), '', $anyone),
    'sms' => r\Web\menu('Test SMS', MENU_CALLBACK, 'showForm', array('SMS'), 'admin'),

    'account' => r\Web\menu(t('Contact Info'), MENU_CALLBACK, 'showForm', array('Contact'), 'manage'),
    'account/contact' => r\Web\menu(t('Contact Info'), MENU_DEFAULT_LOCAL_TASK, 'showForm', array('Contact'), 'manage'),
    'account/basic' => r\Web\menu('Email and Password', MENU_LOCAL_TASK, 'showForm', array('Account'), 'manage'),
    'account/photo' => r\Web\menu('Photo', MENU_LOCAL_TASK, 'showForm', array('Photo'), 'manage'),
    'account/cells' => r\Web\menu(t('Cell Phones'), MENU_LOCAL_TASK, 'showForm', array('Cells'), 'manage'),
    'account/relations' => r\Web\menu(t('Relations'), MENU_LOCAL_TASK, 'showForm', array('Relations'), 'manage'),
    'account/company' => r\Web\menu(t('Company Info'), MENU_LOCAL_TASK, 'showForm', array('Company'), 'manage company'),
    'account/preferences' => r\Web\menu(t('Preferences'), MENU_LOCAL_TASK, 'showForm', array('Options'), 'manage'),
    'another' => r\Web\menu(t('Open Another Account'), MENU_CALLBACK, 'showForm', array('Another'), 'manage'),
//    'account/bank-info' => r\Web\menu(t('Bank Info'), MENU_LOCAL_TASK, 'showForm', array('Bank'), 'manage'),
    'account/usd' => r\Web\menu(t('USD Account'), MENU_LOCAL_TASK, 'showForm', array('Usd', 2), 'manage'),
    'account/id-proof' => r\Web\menu(t('Id Proof'), MENU_LOCAL_TASK, 'showForm', array('Proof', 2), 'manage'),

    'sadmin' => r\Web\menu(t('Admin'), MENU_NORMAL_ITEM, 'showForm', array('Admin'), 'admin'),
    'handy' => r\Web\menu('Handy', MENU_NORMAL_ITEM, 'handy_links', array(), 'admin'),
    
    'membership' => r\Web\menu(t('Membership Status'), MENU_CALLBACK, 'showForm', array('Membership'), 'manage'),
    'membership/status' => r\Web\menu('Membership Status', MENU_DEFAULT_LOCAL_TASK, 'showForm', array('Membership', 2), 'manage'),
    'membership/agreement' => r\Web\menu(t('rCredits Agreement'), MENU_LOCAL_TASK, 'showForm', array('Agreement'), 'manage'),
    'membership/contribute' => r\Web\menu(t('Contribute'), MENU_LOCAL_TASK, 'showForm', array('Contribute'), 'manage'),
//    'membership/video' => r\Web\menu(t('Videos'), MENU_LOCAL_TASK, 'showForm', array('Videos', 2), '', $anyone),
    'membership/proxies' => r\Web\menu(t('Choose Proxies'), MENU_LOCAL_TASK, 'showForm', array('Proxies'), 'manage personal'),

    //    'promo-site' => r\Web\menu(t('Main Site'), MENU_CALLBACK, 'drupal_goto', array('http://rCredits.org'), '', $anyone),

    'settings' => r\Web\menu('Account Settings', MENU_CALLBACK, 'showForm', array('Settings'), 'manage'),
    'menu' => r\Web\menu('Main Menu', MENU_CALLBACK, 'showForm', array('Menu'), '', $anyone),
    'member' => r\Web\menu('Company Profile', MENU_CALLBACK, 'showForm', array('Profile'), '', $anyone),
    'rcredits/util' => r\Web\menu('Util', MENU_CALLBACK, 'util', array(2), 'admin'),
    'rcredits/test' => r\Web\menu('Util', MENU_CALLBACK, 'test', array(2), '', $anyone),
    'autocomplete' => r\Web\menu('Identify', MENU_CALLBACK, 'auto', array(1, 2, 3), '', $anyone),

    'rcredits/backend' => r\Web\menu('API', 0, 'rCredits\\be\\backend2', array(), '', $anyone),
    'api' => r\Web\menu('API', 0, 'rCredits\\Smart\\api', array(), '', $anyone),
    R_GET_AUTH_URI => r\Web\menu('USD Get Auth', 0, 'usdCallback', array('getAuth2', 1), 'manage'),
    'usd-callback' => r\Web\menu('USD Other Callback', 0, 'usdCallback', array('callback', 1), '', $anyone),
    'secret' => r\Web\menu('Secret', 0, 'secrets', array(), '', $anyone),
    'error' => r\Web\menu('System Error', 0, 'rCredits\\error', array(1), '', $anyone),
    
    'pay-with-rcredits' => r\Web\menu('Pay With rCredits', MENU_CALLBACK, 'showForm', array('Buy'), '', $anyone), // form will require login

//    'example-store' => r\Web\menu('Example Store', MENU_NORMAL_ITEM, 'showForm', array('example_store'), '', $anyone),
//    'modal' => r\Web\menu('Modal Test', MENU_CALLBACK, 'drupal_get_form', array('modal_form'), '', $anyone + $modal),
//    'ok' => r\Web\menu('Please Confirm', MENU_CALLBACK, 'showForm', array('ok'), '', $anyone + $modal),
  );
  return $menu;
}

function rweb_menu_alter(&$items) {
  unset($items['node']);
  $items['user/password']['title'] = 'New password';
  $items['user/register']['title'] = 'New account';
}

function rweb_form_alter(&$form, &$sta, $form_id) {
//debug($form);
//debug($sta);
//debug($form_id);
//debug($_SERVER);
  if ($form_id == 'user_pass_reset') return r\Web\resetAlter($form, $sta);
  if ($form_id == 'user_login') {return r\Web\formLogin($form, $sta);}
  // (has no effect, keep as comment) if ($form_id == 'user_register') {return r\Web\formRegister($form, $sta);}
  if (basename($_SERVER['REQUEST_URI']) == 'user' and user_is_logged_in()) r\go('summary');
}

function rweb_form_user_register_form_alter(&$form, &$sta, $form_id) {r\Web\formRegister($form, $sta);}
function rweb_form_user_login_block_alter(&$form, &$sta, $form_id) {return r\Web\formLogin($form, $sta, FALSE);}
// (has no effect, keep as comment) function rweb_form_user_login_form_alter(&$form, &$sta, $form_id) {return r\Web\formLogin($form, $sta);}
function rweb_user_login(&$edit, $account) {r\Web\loginFollowup($edit, $account);}
function rweb_form_user_pass_alter(&$form, &$sta) {return r\Web\passAlter($form, $sta);}

/*function rweb_form_user_profile_form_alter(&$form, &$sta, $form_id) {
  $form['account']['pass']['#process'] = array('expand_password_confirm', 'yourmodule_password_confirm');
}*/
