<?php
// $Id:

/**
 * @file
 * rSMS (rCredits SMS)
 *
 * An interface module for the rCredits financial system.
 */
 
define('TRANSACTION_STATE_STRAW', -3); // add this to states defined in mcapi.module
define('RCREDITS_COMMUNITY_UID', 4);

require dirname(__FILE__) . '/SMScall.inc';

$GLOBALS['SMS commands'] = ''; // defined in $this->parse()
$GLOBALS['SMS messages'] = array(
  // reports
  "account info" => t("Your provisional balance is @balance (accurate only if your transactions as an Active Participant are like your INFO transactions). The current demand for rCredits is @demand."),
  "your account is ready" => t("Thank you! Your new provisional balance is @balance."),
  "if you were active" => t("If you were an Active Participant in the rCredits system, your request would transfer @amount directly to your bank account. Alas, you are not yet an Active Participant."),
  "transaction done" => t("@inaword: @amount @tofrom user#@other (@reward_type: @reward_amount). Your new provisional balance is @balance (If this had been a real transaction, your balance would be @amount @moreless). Transaction ID #@transaction_id"),

  // questions
  "what's your name?" => t("To set up your rCredits account, we need your full name and email address. What's your name?"),
  "what's your email?" => t("Welcome to rCredits, @name. Last question: What is your email address?"),
  "what's your email really?" => t("Please type carefully. What is your email address?"),
  
  // help messages
  'help for payment' => t("Payment examples: 12.34 to 413.772.0000 | 12.34 to wgabcd for cash | 12.34 to jdough@example.com for wine and cheese (Include a description ONLY if it's \"cash\" or if you are providing real goods and services.)"),
  'help for charge' => t("Charge examples: 12.34 from 413.772.0000 | 12.34 from wgabcd for cash | 12.34 from jdough@example.com for wine and cheese (Include a description ONLY if it's \"cash\" or if real goods and services are provided.)"),
  'help for undo' => t("Examples: undo | undo to | undo 413.772.0000 | undo from wgabcd"),
  'help for get' => t("Examples: get r 12.34 | get usd 12.34"),
  'help for information' => t("Example: information (tells you your balance and the current demand for rCredits)"),
  'help for help' => t('Examples: @commands. For example, type "help undo".'),
  
  // error messages
  'syntax' => t('Syntax error.'),
  'no SMS permission' => t('Alas, you do not have permission to use the rCredits SMS interface at this time.'),
  "can't cash incentives" => t("Once you are an active participant, you can spend your incentive rewards (@balance to date), but you can't cash them out. Your balance available to exchange for US Dollars is $0."),
  'get r/usd' => t('You can get only "r" or "usd" (rCredits or US Dollars).'), // not yet used (maybe used when there is a third option)
  'not a feature' => t('"@param" is not a feature.'),
);

/*
 * rSMS text
 *
 * Get the long version of the indicated message(s), make any substitutions,
 * and return the result.
 *
 * @param string $message
 *   name of the message (index into $GLOBALS['SMS messages'])
 *   may be a list of message indices, separated by "|"
 *
 * @param array $substitutions (optional)
 */   
function rsms_t($message, $substitutions = array()) {

  $messages = explode('|', $message);
  $result = array();
  foreach ($messages as $message) {
    $result[] = t($GLOBALS['SMS messages'][$message], $substitutions);
  }
  return join(' ', $result);
}

/**
 * implements hook_help
 */
function rsms_help($path) {
  switch($path) {
    case 'admin/mc/sms':
      return t('Define the SMS syntax for recording exchanges');
  }
}

/**
 * implements hook_form_alter, to set focus
 *
 * Insert a snippet of javascript in the page footer, to set the focus automatically
 * on the message field of the SMS simulation form.
 */
function rsms_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'sms_devel_receive_form') {
    drupal_add_js("document.getElementById('edit-message').focus();", array('type'=>'inline', 'scope'=>'footer'));  
  }
}

/**
 * implements hook_menu
 * UNUSED
 */
function rsms_menu() {
  $items['admin/accounting/sms'] = array(
    'title' => 'SMS transactions',
    'description' => 'Define the SMS syntax for recording exchanges',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rsms_settings'),
    'access arguments' => array('configure currencies'),
    'weight' => 5,
  );
  return $items;
}
/*
 * implements hook_permissions
 */
function rsms_permission() {
  return array(
    'Transact via SMS' => array(
      'title' => t('Transact via SMS'),
      'description' => t("Transfer funds and get account information through the SMS Interface"),
    )
  );
}

/*
 * implements mcapi_info_types
 */
function rsms_mcapi_info_types() {
  return array('smsIn', 'smsOut', 'smsOther');
}

// delete this?
function rsms_settings(){
  $form['responses'] = array(
    '#title' => t('SMS Settings'),
    '#description' => t('You cannot change the SMS syntax here.'),
    '#type' => 'fieldset',
    '#weight' => -2
  );
  return system_settings_form($form);
}

/*
 * SMS Incoming implements hook sms_incoming
 *
 * @param $op
 *   'pre process', 'process', 'post process'
 *
 * @param string $number
 *   the calling phone number
 *
 * @param string $message
 *   the incoming message
 */
function rsms_sms_incoming($op, $number, $message) {
  switch ($op) {
    case 'pre process':
      break;
    case 'process':
//	  $number = '4111111111'; // test unregistered phone number
      $call = new SMScall($number, $message);
      $call->send($number, $call->handle_call());
      break;
    case 'post process':
      break;
  }
}

/*
 * this is for the demo only, should be in a separate module, really
 */
function rsms_form_sms_browser_gateway_incoming_form_alter(&$form, $form_state) {
  $form['number']['#access'] = user_access('edit all exchanges');
}
