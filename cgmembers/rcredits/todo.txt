rCredits Software
To Do

. get a new device for GFM

Before growing fast:
. ACH at TDBank (need EIN doc, cert from town, signers in person with ss#/dob/license/physAddr)
  (treasury management)
. DONE emails and invites don't get marked as spam
. DONE economic circle(s)
. 2 more new board members, including a business leader
. ID verification
. Software: invoices, sound admin tools, bal not r

TASKS FOR NEXT UPDATE:
after reinstall:
(no other special tasks yet)

. add something to the website that mentions Ann Arbor and directs people to that facebook page (https://www.facebook.com/A2rcredits) and their email address. Is that something to ask the board?

. fix EditTx test so it handles variable link ("?")
. add tickler for invitations
. track buyers and sellers in stats: SELECT DISTINCT uid,fullName FROM r_txs t, users u WHERE uid IN (payer, payee) AND uid>1 AND payee<>26742000000002 AND payer>0
. scatter graph: sector II x-axis buyers (primarily) pay y-axis sellers (primarily). sector I y-axis sellers pay x-axis buyers (mostly payroll), order by how extreme ($bought-$sold), with extremes on the top/outside
. added a "I connected them to Dwolla" button on Member Info page
. move photos to /sites/photos and rename them uid-photoCode.jpg (photoCode is null for companies)
. tell newbs their bank's phone number (to make it easy to confirm the deposits)
. if state lookup fails, member gets uid USA.AAA and the default community. Should give an error message and "retry".
. The meaning of "cashing out" should include only: (1) trading rCredits for USD at an official rCredits exchange (a member business that has agreed to provide that service) and (2) transferring funds to one's connected bank account.
. don't update the access field in the users table when admin or cadmin or cadmin2 accesses the account (similar for login)
. don't allow a one-word use-name easily. Also, ask for full name first, then legal name (if different).
. Adam: I've noticed the rcredits member site keeps me logged in long after I've stopped using it, even after I close the tab and then reopen it hours or days later. For a financial site where money can be moved, I'd recommend either auto-logout after 10-20 minutes of inactivity, or (better) requiring me to re-enter my password before doing certain things like paying people if it's been more than 10-20 min since I last entered it. 
. on NSF for cash/loan/etc., explain that rewards cannot be cashed out
. "connect bank" button on memberdetails page
. implemented a FREEZE button for cttyadmins (disables transfers of USD out)
. change cached "r" field in users to bal (total of r and usd)
. tentatively implemented invoices as emails, as for "buy now with rCredits" buttons (a copy of the email goes to the sender, prefixed by "you sent this invoice to XXX on YYY:"). Invoices are permanent. Link has a weak security code -- maybe the account created date
. use legalName on Relations page!!
. now includes inviter in proxy list
. implemented effective minimum for unbanked accounts that can draw on one or more others
. Pay page does not figure shortfall properly (omits draw!)
. If Matt leaves his phone untouched for X minutes and Sheila picks it up, should it insist that she sign in? Or at least say “Are you still Matt?” ?
. Should we not allow you to undo the last transaction if it was more than Y minutes ago?
. remade patch files
. made "back to member list" link on member info page go to bookmark for the edited account
. fixed messy security page for admins
. added charts to Community page: live line graphs showing trends over the past month or year (separate for counts and for amounts), pie chart for type of transaction over the past month (p2p, etc.)
. made some Preferences "advanced"
. added "[?]" to "cash/loan/etc", linking to more info -- including an example of reimbursement
- let user choose chunk size for automatic bank/draw transfers -- stored in "data" in the users table.
. add a checkbox for "I don’t have a bank account" (and I can find another rCredits member to pay me in rCredits or trade rCredits for US Dollars or allow my account to draw from their account automatically) 
. let other communities have a list of not-yet-members
. added a users data field: require PIN for purchases over $x. (requires a change to App also)
. option to send text message on purchase
. let admin change goods status of a tx?
. * add a Pay button to member company rCredits webpage
. remind people to confirm their bank account (and say how -- call the bank, etc.) -- also other reminders based on how long after particular events, such as signing the agreement, first tx, last sign-in, last invite, etc. (SELECT max(), max()... from users left join this on uid=uid left join that...)
. * hide advanced features on Transactions page (show either advanced or simple period selector, but not both)
- * detailed membership tests: New Pass, Photo, Agreement, Donate, Proxies, Usd, proof of ID, Options

. maybe change tx type from TX_SIGNUP to TX_PIONEER for early txs where payerFor='pioneer bonus'
. Avoid "attempt was made to transfer from your bank" message by selecting only users with IS_BANK, BUT starting one day after signup, notify member what the next step is AND give them daily messages until they have completed the signup.
. add the agreement to rCredits.org
. give admin tweak msg upon SHOWING bank form
. *** txs should not show X on receipts, for non-buyers
. *** monthly pdf statements
- ** implement r\suggest (use this for merchant invoices too. user gets an email invoice from rCredits, they can just click a link to accept or decline. merchant gets notified). test cron call to r\suggest (should just notify, for now)
- for admin, put initial gift and share% on member's Summary page (attached to addr)
. when opening "another account", pass type (personal or company) to signup form (already does?)
. doing bank step out of order gives Dwolla error "User must be verified." Handle it or forbid form until then.

. Suggestions from Mike:
• I think I had to click “Upload and Save” twice, once to upload-and-display, once to save. Is that correct?
• The place which now shows a teeny photo was a [-] before. Confusing. Omit it from the web page entirely?
• The phrase “Checking accounts work best because of legal restrictions on other types” But why not attach that warning to the second radio button? Just “(these won’t work as well as checking accounts…)” ?
• A picture of where to find routing and acct numbers would be nice. Sort of like http://www.nationwide.com/routing-and-account-numbers.jsp does. Or draw a mockup of a check and put those two fields in the right places.
• The full-contact-info page asked again whether to verify by text or voice. Does it really need to know that?
• Instead of “Choose File” in the upload-photo page, how about “Choose Photo”? (make input an invisible overlay): http://stackoverflow.com/questions/5191375/a-file-input-button-for-all-browsers-is-this-possible/5191970#5191970

. The software will need to provide an easy way for businesses to use rCredits for payroll. Adam suggests letting businesses upload a spreadsheet, for example.
. To handle a “run” on rCredits, Community Admins should be able to freeze rCredits/USD exchanges until the community has an opportunity to meet to discuss solutions.
• routing number and federal ID: could be nice to light up when I have the correct number of digits.
. make proxy choices scrolling lists (with html size=20 ?), maybe the two choices side by side
. write test or test procedure for updating usd cache when shortfall but funds have arrived in Dwolla (have to test it on production server)
. create an rCredits charge&pay app (modify rPOS) for members to charge or pay other members (rather than be charged). It might be expanded later to include account features.
. implement two-factor signin
. write ajax to remember country and state in Contact form, on blank field error
 don't create account (in acct class) if email is a dup
. when admin reactivates an account, member gets an email with a bad password (it should send a new temporary password without altering the saved real password) done?
. on member list, click "dw" to get current step
. handle cards reported stolen at POS (how? ask Visa)
. on transaction page: action on far left, reward next to "to you"
. cash/loan/etc vs. goods & services: provide a link to help the member decide which
. advanced feature: see breakdown of USD/rCredits for one's account (with explanation of why it changes)
. automate account deletion and make sure it deletes related records
. sort transactions by date before download (already does, for display)
. report proper balance on tellStaff about gift
. withdrawal should disable minimum if necessary to avoid an automatic reversal of the withdrawal
. allow user to change box name (can change computer box name only if currently on that computer)
- * reduce picture size and make thumbnails (for upper right corner)
. check and correct deposit/withdrawal status (and balance) when visiting bank tab
. selecting a new account when site has timed out and signed the user out, should do something reasonable
. fix community page transaction list for admin
. take B_BONA off region and add B_CO
. fix layout of member webpage (description gets jammed into narrow div)
. send a statement to each member monthly. if it bounces, call, then shut down the account 7 days later (with a notice) and send a text immediately and/or US Mail pcard later, saying we need a new email address (with easy instructions for doing it, including what to do if they don't remember their password (first make an exchange of a certain amount of cash for rC at a member business, as an identity check?, then go online and use that as their temp pw)
. no cardcode for businesses (in acct class)
. no password for businesses
. start with 0 bal, charge customer $20, then undo. fails.
. explain yellow highlight on Relations page
. *** omit "request rCard" on relations page if account has not been approved
. LATER add option for company to enable access by others to their device(s). But default to no access. That way, an unsigned-in cashier can't accidentally sign in another company's agent. ("restricted" field in r_boxes? B_READ means "can use our rPOS devices" in relations form?) May require a A.testDevice param in rPOS.
. give stage server hidden fields! (currently crashes on $a->dob)
. * when user has no access to the page, show login page if user is not logged in (requires a change to Drupal)
. trying to change company name and email complains that phone is already taken
. in admin a() handle non-local regions right
. * write rweb feature tests for automatic one-click actions (see rcron/features/old/SoldOut.feature for an example)
- * help for all pages
- * in daily: alert staff if deposit / withdrawal not complete after 5 days

. any account can unilaterally charge an account it has permission to draw on
. company search on production server gets collation error (search for "food") (not critical)
. hover help on relations page
. committed amount can go negative (on a refund). make sure cron handles it right.

. show the right thing for bank transfers for cadmin statistics page or hide them
. have Gherkin always send us the whole array, which must still be rectangular. use t\hdrs() to make the first row or column keys/hdrs for the others
. drive xml error from USPS on Signin, and handle it gracefully
. rewrite form testing system to use just menu_execute_active_handler, drupal_validate_form, etc. (assuring official behavior). For example, be able to test required fields.
. (later) suggest reaching out to increase rebate pct
. handle menu logout from restricted page (does not log out)
. (later) use rc4.me for login and email redirection (with forward.php). Database table accounts has fields email (primary), username (all lowercase letters), and region (3 or 4 uppercase letters). So user can log in at rc4.me (linked to by rcredits.org), which then forwards the request to the appropriate server. Scanned cards go directly to the proper server (new.rc2.me/A/AAAcode OR /a/... for agents, B&b for 4-letter users, etc.).
. before depending on anyone's cached USD balance, make sure the unavailability of their Dwolla account is not because they changed their PIN.
. add to misc.js: for each text input on the page, if the current value includes "XX-", make it silver. onEnter, zap the contents (set .length=0 ?)
. when there is an error, don't make user retype the hidden fields (so soc sec and dob should not be password type) (also when error happens in submit, because there is a dwolla error)
. don't make account opener manager if by is ADMIN or cadmin (and give account a temp password)
. warn admin when changing to rTrader prematurely, that it may cause double withdrawal from bank (happened to Dan)
- when contesting a tx, ask for comment (add it to payer's "for"). The next day (and thereafter) don't allow editing the for. Include payer's note in notice to payee.
- LATER (when available) tests with dev sandbox and reg sandbox!
- LATER bank account removal
- move SMS notices option to cell form (and add field to r_boxes)?
- on MSIE 8, sign-in CSS has alignment problem, menu failure in MSIE 8, autocomplete looks funny
- LATER give user a chance to name the machine
* LATER prefs: "Show address (show my address to companies I pay or donate to)" -- just assume TRUE for now. 
- make a way for user to see notices online
- anti-scam: if USD goes out of an account twice in quick succession, set an "always check USD bal" flag (then don't allow a tx if Dwolla is down) and/or change coverFee() to afterUsdTx() and check both parties' real USD balances
- combine channel and box on Transaction History?
- warn people about their tax liability (ask what their tax year is? warn in December?)
- trans history: default today on starting/ending and/or pass true defaults properly for period
- make sure we're handling all bad GET data gracefully
- no rebate / bonus for manager of company with no (other) employees (set bit?)
- add a login field to relations and record last login time of agent/company pair
- return error from u\httpRequest() (instead of u\EXPECT), throw hiddenData error in acct::offsiteData(). Catch it on Summary screen at least (display gentle Warning message).
- option to never convert r to us. rCredits can then be seized only by the CGC. No. this is still problematic because it invites abuse and might pit the community against the individual or against the larger society.
- account checks: auto-deposit or minimum>0 but not connected to checking account yet: notice to user
- block repeated 404s
- pagination for trans history
- recommend password practices
- rethink nested usd transaction atoms (is the logic right?)
- retest SMS
- handle 10-day interval for deposits/withdrawals for non-checking accounts
- Hilary's list
- * don't allow clicking on links in emails (send to new.rcredits_org.com/whatever, which looks like rcredits.org but scolds the user for clicking on an email link, then offers a link to the real site (don't accept that one either). Exception: links that do not require sign-in (for example, suggested account changes and merchant charges -- merchant creates invoice. no shipping until you accept it -- like paypal).
- settle where email links go and what they do
- create region records as needed, when a new member is outside NEW. Handle region totals in r\total()
- in r\transact() we should rollback the transaction if it leaves the payer in unauthorized debt (due to a timing error that might be exploited intentionally by a determined hacker)
- Maybe remove security algorithms from public view (see https://help.github.com/articles/remove-sensitive-data)
- add share to summary page, for admins (or allow $0 donation and don't record it)
- receive deposit/withrawal callbacks to set "completed" in r_usd. alert staff if fails.
- demo button on rcredits.org goes to login with options to log in as abeone, beatwo (self-employed), cornerpub, or townarts (which should have a "Donate" form on its member/townarts page)
- "sign" our invite emails so gmail and others won't see them as spam (needed?)
- give ctty admin a way to reset a member's password (assign them a one-time pass, set a one-time bit)
- /password should give error if user is logged in
- back button
- revisit t\addAttrib and t\snapshot (does Drupal make ids lowercase?)
- phase out tablefield and/or userfield
- 1/6 month credit after first month, etc. up to 6 mos.
- make digests viewable online
- nightly: recalc exchange rates / allow users to express amounts in any currency (rounding DOWN); transactions will need to record exchange rate (true currency will be tied to region, regardless of how the user chooses to have it displayed)
- how much can the community safely create? this depends on velocity of circulation and two kinds of demand: 
    (1) company/employee/contractor demand and (2) other (by people who have no rCredits income source)
    The first kind reflects the inherent strength of the system, the second should be seen as backup
    We can create the amount of the first kind divided by velocity, probably.
- travel checks (use once, limited amount)
- allow extra params in buynow form
- for companies, show HTML for online payment buttons
- make personal contact info secure?
- Company profile picture will also appear in our office slideshow. Say so on company tab.
- (2013-02-13) i had a dream last night that peace prevailed among the human planets because a benign alien race provided a way to verify the identity of any speaker. This morning the following ideas came to me, about how to approach that ideal. Members should be able to choose their security method:
  . whenever the transaction is between accounts from different regions, in-person merchant must ask the customer for a "travel word". The system reports a new travel word (for next time) that the merchant then tells the customer.
  . the foreign in-person merchant can ask for a PIN (that doesn't change)
  . the customer must show a separate photo ID
  . the customer must pay with an ad-hoc smartphone QR, rather than a card (best). The QR is valid for only 2 minutes (and only once).
  . either in-person or online, the customer must verify the purchase by text message or email (within 2 minutes or so)
  . online, no extra security for requests from the usual machine/IP/cookie. Otherwise customer must first go to the rcredits website separately and log in (you can create an icon, to make this easy).
  . different options may apply for different charge amounts. Rate the "level" of each method and suggest appropriate levels/defaults for (rounded) price ranges (0-5, 6-25, 26-100, 101-500, 501-2500, 2501+)
  . "Protect yourself from identity theft: (give standard tips, plus:) As long as you are using rCredits on *this machine*, we will not need to ask you any security questions. Do not sign in to rCredits on a machine you don't trust. If you must, then as soon as you get home, check your transaction history and change your password and security questions. If you are shopping online at a non-local site, when it comes time to pay, make sure you are really on the rCredits site (show what to look for).
  . (when the member buys something online from a foreign site, from an unusual machine, ALWAYS require confirmation by email. Do not show settings except from home machine)
- relation.class
- Coding security policy: never show any personal identifying info (R_SECRET_FIELDS) in the HTML. EVER. For example, when verifying someone's identity, the staff member should ask for the last 4 of their ss#, type it in and press submit. The code does a compare and returns just yes or no. Even the member cannot ever see what they earlier typed in. We might want to have a similar but weaker restriction on phone numbers and addresses -- like maybe those are protected for personal accounts. When 1099 time comes, the reports go out electronically only (no preview, etc.) Even user 1 and other admins don't have access to PII. Also put in some safe-guards to prevent repetitive guessing.
- beef up security 
- I figure we can continue without interruption or pain for a few days whenever Dwolla goes down. The current plan is to give everyone (everyone who has been a member for at least a month) one month of reserve credit -- that is, however much rCredits they earned in the past 30 days plus however much rCredits they typically buy (with US Dollars) in 30 days. No fees for that loan as long as it is paid back within 30 days or within 3 days after Dwolla comes back up, whichever is later.

  It would be good to have an alternate way to trade rCredits for USD before that happens.

  Let's hope that by the time we get a DoS attack on a regional rCredits server, we're big enough to hire competent people to fight it. As a corollary, we probably want to encourage regions to use large hosting companies rather than small local ones. Unfortunately.

  We will also want a way to cope with internet outages (local or national). (David this paragraph is mostly for you, after the next sentence.) The current plan is to develop a mobile app that saves a working copy of the entire system in a distributed network (of smart devices) with lots of redundancy. For example, we want each merchant's device(s) to recognize their repeat customers. Each new customer who pays with a smart device (rather than a card) (which we will encourage at some point, perhaps by giving people an extra $5 if they forgo the card, or an extra penny per transaction) brings data to the merchant:
  some encrypted gem that gets passed from member to member on each transaction, to prove their identity and/or balance and/or connection to the merchant's community
  miscellaneous (encrypted) transaction data to add to the merchant's records. (This might just be a second purpose for the same data.)
  In such times, even participants without a smart device could be given a paper receipt that is a single large QR code, to carry to their next transaction. Better, they could be given a (re-writable) mag-stripe card (or the equivalent) that the next merchant reads and re-writes.

TODO whenever

- security later: 
  . Make the agent's picture appear from behind the "r", get big, then shrink and settle into place, traveling in the shape of an "r", ideally leaving a jet trail.
  . How to prove the logged-out site is rcredits? Maybe always ask first "It looks like you came here from an rCredits member site. Make sure this is the real rCredits website! Does your url bar say https://new.rcredits.org? Does it show a security symbol? We will display this reminder only once in a while. Don't let the identity thieves get you. Be sure to check the url bar <i>every time</i>."
@todo: add videos, like this:
  <video width="320" height="240" controls autoplay>
    <source src="movie.mp4" type="video/mp4">
    <source src="movie.ogg" type="video/ogg">
    <source src="movie.webm" type="video/webm">
  Your browser does not support the video tag. (maybe embed a clickable vid in an iframe here?)
  </video>
@todo: rate each account health as ratio of total demand of repeat payees (2x/2.5mos) to total demand of recent payers (2.5mos) (potential for future) OR to monthly sales (current health); also rate of change of sales volume (maximize for everyone and not negative)

/**
 * Return a number or recordset representing the health of one or more accounts.
 * @param string $where: a uid or criteria for account selection
 * @return: a number representing the health of the specified account OR a recordset given the health of each account
 */
function health($where = 'TRUE') {

  if (is_numeric($where)) $where = "uid=$where";
  
  $payeeDemandSql = demandSql('payee', 2, 2.5, $where);
  $payerDemandSql = demandSql('payer', 0, 3, $where);
  $return eachAccount($queries, $ons, $where, $subs = array()) {

// * @param string $measure: current, future, count, or growth
  if ($measure == 'current' or $measure == 'growth') {
    $lastMonthSales = db\q(salesSql(1, $where));
    $prevMonthSales = db\q(salesSql(2, $where)) - $lastMonthSales;
  }
  if ($measure == 'growth') {
    return u\small($prevMonthSales) ? (u\small($lastMonthSales) ? 0 : 1) : ($lastMonthSales - $prevMonthSales) / $prevMonthSales;
  } elseif ($measure == 

compact('myid', 'months')

list ($me, $months) = array('payee', '2');
$last2MonthsSales =

/**
 * Return a query that will return payee,sales1,sales2,sales3
 * where the salesN fields are total sales for the payee for the preceding (non-calendar) month, month before that, etc.
 */
function salesSql() {
  $fields = 'payee';
  for ($i = 0; $i <= 3; $i++) {
    $nextMonth = @$monthi;
    $monthi = strtotime("$i months ago", REQUEST_TIME);
    if ($i > 0) $fields .= ",SUM(IF(created>=$monthi AND created<$nextMonth, amount, 0)) AS sales$i";
  }
  return "SELECT $fields FROM txs WHERE type=:TX_TRANSFER AND goods AND created>=$monthi AND payee=u.uid";
}

/**
 * Return a query that will return (total) demand for an account's payers or payees in the recent past.
 * @param string $other: payer or payee
 * @param int $minRepeats: consider demand from members who did business with the account at least this many times
 * @param int $months: how far back to look
 */
function demandSql($other, $minRepeats, $months) {
  $earliest = strtotime("$months ago", REQUEST_TIME);
  $me = $other == 'payer' ? 'payee' : 'payer';
  return <<<EOF
  SELECT SUM(GREATEST(0, minimum-r)) AS demand 
    FROM (SELECT $other, COUNT(*) AS count FROM txs 
    WHERE type=:TX_TRANSFER AND goods AND created>=$earliest AND $other>0)
    INNER JOIN users u ON u.uid=$me
    WHERE count>=$minRepeats
EOF;
}

function eachAccount($queries, $ons, $where = 'TRUE', $subs = array()) {
  $fields = 'u.uid';
  $tables = 'users u';
  foreach ($queries as $q => $query) {
    $on = array_shift($ons);
    $fields .= ",$q.*";
    $tables .= ",($query) $q ON $q.$on=u.uid";
  }
  return db\q("SELECT $fields FROM $tables WHERE $where", $subs);
}

@todo: move some util functions, like ray(), to rcredits-basic.inc and "USE" them everywhere without a namespace qualifier.
@todo: allow surrounding spaces on all web input, leading dollar signs in amounts. Test. (mostly done)
@todo: we also need some kind of confirmation on foreign transactions (from the other server)
@todo: store city code (rather than city), with a code for "other" -- store other in data or r_other (same for country/state) MAYBE
@todo: reporting for a community or server (a form that anyone can use)
@todo: download transactions in other standard formats
@todo: Finish separating backend. Front end should have no registered users. This should maybe wait until after launch.
@todo: use popups for some things
@todo: make help divs draggable
@todo: option to suppress current balance in messages (make it a separate message) B_SHOWBAL (default TRUE)
@todo: Miscellaneous other data to collect:
  Names and Social Security Numbers of Dependents [and answer: why do we need this?]
  If this is a joint account, do you want separate balances? (if so, it will be treated as separate accounts except that available funds may be transferred automatically to any of the joined accounts that dips below its credit limit.)
@todo: closed accounts have only read perm and point (data[new_account]) at new account qid
@todo: servers exchange info on which ss#s (or other ids) are dups
@todo
- remove all direct db operations from interface modules (and their .inc files) -- use be\ and u\ there, but not r\
