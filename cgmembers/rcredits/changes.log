2014-05-15
. UPDATE r_invites SET invitee=0 WHERE invitee IS NULL
. fixed bug: summary balance omitted usd
. revamped "we send email" tests
. comprehensive tests for signin and password reset
. eliminated Contact step by including it in initial signup form, using Google's zipcode lookup api
. anyone with refund permission now gets a "request card" link on Relations page
. we now explain the 5% APR inflation adjustment as what we’re using until we have a realistic number.
. we now figure savings as total of 30 day minimum balance
. stats are now calculated in such a way that we can redo them all retroactively, using admin fixStats()
. stats for all communities
. improved help for charts
. UPDATE users set r=0 WHERE uid<1
. re-install
. UPDATE r_txs t LEFT JOIN users u ON u.uid=t.payee
  SET t.payer=u.community 
  WHERE t.payer<0 AND t.payer<>u.community
. include __DIR__ . '/../rcredits/admin/admin.inc';
  rCredits\fixStats();
  rCredits\fixStats(809); // where the previous run ran out of time
. fixed bug: stepDone(dw) was looping
  
2014-05-02
. asks for full name first, then legal name (if different), to discourage people from giving a nickname
. fixed EditTx test so it handles variable link ("?")
. added cron tickler for invitations
. if state lookup fails in signup, state defaults to MA
. when signed out, footer links now include community, agreement (no boxes) and help (for signing in or up)
. don't update the access field in the users table when admin or cadmin or cadmin2 accesses the account (similar for login)
. we now let user choose minimum size for automatic bank/draw transfers -- stored in "data" in the users table.
. fixed signup page to clarify that full name and legal name are for the business (when they are)
. stopped making user type one-time passwords (we now use a clickable link instead)
. created a way to sign in from rCredits.org: formSignin
. we now ask for PIN on signup form
. password reset form is now separate from login form, but sends user on to summary page with no signin required
. implemented effective minimum for unbanked accounts that can draw on one or more others
. update user.module and user.js

2014-04-17
. added charts to help pages
. created a page to edit transactions (lets seller adjust amount down and buyer adjust the amount up.)
. added a tickler cron function which give people nudges for taking next steps
. modified rCredits Agreement by adding these two clauses:
  - Once my geographic area becomes a Common Good Community, in the event of a cash crunch I will back rCredits up to my average balance over the past six months.
  - that I can spend but cannot cash out.
. created B_REFUND permission
. changed permission=5 to 6: UPDATE r_relations SET permission=6 WHERE permission=5
. changed the way undo is handled (now creates a negative charge instead of an offsetting payment)

2014-04-04
. added date/initial stamp to notes on Summary page and Member Info page
. revised changeUid function to accommodate account deletion
. fixed bug: member bit not getting set in acct::stepDone()
. don't alert staff when admin invites someone
. community admin gets an email when community's new members achieve milestones in their account opening
. fixed $/acct for p2p on Community page
. separated invoices from r_txs (somewhat major change)
. changed Community page to charts
. made Community page public (show all cttys if signed out)
. added a payroll upload page
. drop table r_invoices
. duplicate r_stats for ctty=0, then:
  UPDATE `r_stats` SET id=id-600 WHERE id >999 AND id<10000;
  UPDATE `r_stats` SET id=id-9600 WHERE id >9999;
. added newb field to stats
. ran fixStats to update and correct r, usd, and newb data in stats
. added relevant dates to MemberList form
  
2014-03-13
. hide federalId and dob in $_POST in log
. membership status page now shows Verify bank account as a not-yet-done step.
. added tellStaff to remaining signup steps.
. created new system for no-signin links, including one-time links, addresses, and invoices
. removed B_PERSON bit
. added stepsDone assoc in users table data field, to track account-opening step completion
. removed Connect to Bank step for companies
. moved tellStaff to stepDone function
. changed "Owner" to "Owns 10%+" on Relations page
. now links to memberlist on admin page
. added notes to CGF member list
. now allows cadmins to shut down system just for their community: made the START/STOP button work for Community Admin (for that community/region), so members there can open account, move money to and from bank, but not transact until community is activated (and Community Admin can shut it down in an emergency). It tells members to contact the ctty admin (give telephone # and email)
. stopped showing "processing" when user clicks on a help link
. lets cadmin invite list of emails
. fixed bug in Dwolla registration that neglected to record the Dwolla account number. Called usd::me() for each account, to catch up on any missing account numbers.
. moved all admin stuff to a separate folder
. introduced cAdmin2 (community sub admin) permission, to allow assistant to see member list and modify account notes
. changed "recurs Monthly" to "4th monthly" etc.
. db changes:
	new.rcredits.org/devel/menu/reset
	ctty('aaa')->setBit(B_MEMBER);
	ctty('aaa')->setBit(B_OK);
	ctty('miw.aaa')->setBit(B_OK);

2014-02-25
. eliminated preemptive "dupOk" field in signup.
. removed verifyBy from Contact page
. changed automatic state in postal address to abbreviation
. allowed entry of bank account info before there is a Dwolla account
. added Admin tool to send bank account info to Dwolla
. staff is no longer notified when admin sends an invitation
. fixed account approval message (was sending welcome email)
. created Invitee List link on Invite page
. changed "From Bank" to "From Bank to Here" and "To Bank" to "From Here to Bank"
. in notice digests, finishes with current balance, incentive rewards to date, effective return on your rCredits balance APR (averaged over the past month)
. created admin tool to make a new region or community
. limited community admin choices and results on Admin page
. created new region: ^48(103|104|105|107|108|109|113|115|130|158|175|176|190|191|197|198) rCredits Washtenaw County, MI (MIW) on production server
. fixed bug that kept Grants page from working
. fixed bug that made community's summary page crash
. added "recurs" note to recurring transactions
. fixed bug: dollar sign in input caused problems on Bank page
. now logs just i/o, not db ops
. when administering region, Txs page no longer shows bank transfers nor everyone's transactions, distinguishing it from call on community page.
. brought half the SMS tests up to date
. changed region and community numbering to mirror account numbering (region is just -XXX.AAA; each community is within its region: -XXX.AAB, etc.)
. bug fixed that created a relations record with NULL other upon signup
. allow cadmin to print-id
. cadmin should not have access to SeeSecure (or print-id) for out-of-region accounts
. tells cgf how often a donation happens
. invite email message defaults to last used (store in data)
. changed community field in users table to BIGINT
. queries:
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Massachusetts', ', MA');
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Ma.', ', MA') WHERE name LIKE 'gop%';
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Michigan', ', MI');
  UPDATE users set postalAddr=REPLACE(postalAddr, ', New Hampshire', ', NH');
  UPDATE users set postalAddr=REPLACE(postalAddr, ', Vermont', ', VT');
  DELETE FROM r_relations WHERE other IS NULL;
. code:
  rCredits\changeUid(-8915, -26742000000001, FALSE);
  rCredits\changeUid(-8321, -25026000000001, FALSE);
  for ($i = 1; $i <= 10; $i++) rCredits\changeUid(24960000000000 + $i, 25026000000000 + $i, FALSE);
  \variable_set('r_totals', array());

2014-02-12
. fix data (already done on production server):
	DELETE FROM r_txs WHERE xid IN (76,77,78);
	
	UPDATE r_txs t0 LEFT JOIN r_txs t1 ON t1.xid=t0.serial
	  SET t0.payerTid=t1.payerTid, t0.type=1, t0.serial=t0.xid,
	  t0.payerFor='payment exchange rebate', t0.payeeFor='payment exchange rebate'
	  WHERE t0.type=-1 AND t1.payerFor='payment exchange' AND t1.amount=0;
	  
	UPDATE r_txs t0 LEFT JOIN r_txs t1 ON t1.xid=t0.serial
	  SET t0.payeeTid=t1.payeeTid, t0.type=1, t0.serial=t0.xid,
	  t0.payerFor='payment exchange bonus', t0.payeeFor='payment exchange bonus' 
	  WHERE t0.type=-2 AND t1.payeeFor='payment exchange' AND t1.amount=0;
	  
    DELETE FROM r_txs WHERE amount=0
. fixed bug in cacheTotals that did not recognize when an account was BONA
. fixed new bug in transaction logic that treated unconfirmed web/SMS transactions as confirmed (resulting in a duplicate transaction)
. made adjustments in formMembership (see $dw0) to work around Dwolla's broken Reg API
. fixed bug in 1099 reporting that deleted a couple characters in each person's name, when reporting to the IRS
. adjusted 1099 reports to omit non-positive transactions, as required by the IRS
. added "this is a donation, not a deposit" to Donation page.
. changed default phone format separator to spaces not periods
. fixed bug in cron notices that gave the same date for every item

2014-02-04
. clarified that when user opens another account, they will manage it (with no separate login)
. when someone is denied for NSF, sends a notice to them suggesting a higher minimum
. requires agent's LEGAL name, signing agreement
. when creating postal addr, use state abbrev (only for MA so far)
. invites people to email their photo instead of uploading it
. non-daily digests include date of notice

2014-01-31
. made invite a primary link
. made sign out a primary link
. shortened transfer time from bank: when there are insuffient funds, now updates cached usd amount and retries.
• fixed bug: "I didn’t give a security answer, but it says on file"
. we now check hourly for deposits into the Dwolla/rCredits account
. member is now alerted immediately when funds arrive in their account for the first time (bona)
. created 1099B reports for members and for electronic filing with IRS and state

2014-01-27
. fixed bugs in usd::rollback, injected during separation of USD transactions from r_txs
. fixed many cosmetic problems and minor bugs discovered by Mike
. fixed state not updating problem on Contact page
. fixed verifyBy=SMS default not showing on Contact page
. refactored data field to include company fields and act (virtually) like any user table field
. added legalName field
. accepts "none" or "n/a" in lieu of blank, for some fields (eg company and companyPhon)
. fixed bug: now ignores spaces in bank account number and routing number
. data changes:
  - move companies data to data field in users table
  - move signupCo fields (company companyPhone isOwner contractor EmployeeOk) to signupCo in data field in users table
  - move these data fields to data['stats']: giftsEver, giftsPastMo, beneEver, benePastMo, extraEver, extraPastMo, bankedEver, bankedPastMo, avgBalPastMo, avgBalEver 
  - set legalName equal to fullName in each account
. delete r_companies
. improved password strength descriptions

2014-01-23
. exchanges of r for usd are no longer in r_txs -- they are in r_usd only. All transactions between members are rCredits only. This made the "r" and usdXid fields in r_txs moot so they are gone. (Can't put this on server until data changes are ready)
. fixed bug that kept set-password from working for admin (patched)
. fixed bug in formGet (Bank tab) that got USD for the community instead of the member (made new test for it)
. fixed bug in cron that reversed sign of transfers to bank
. fixed bug in creditInfo that bumped in and out by rIn and rOut, respectively
. fixed bug: verify bank deposits was mishandling ".01"
. members can now open an account without a dwolla connection, if they have only one phone or if approved by admin (when Dwolla refuses to open an account for them)
. mark transfers to bank complete immediately (as Dwolla does)
. cache is now updated properly upon completion of transfers into the rCredits account
. account is suspended if cron discovers any cache error
. cache is checked before manual transfers to bank
. data changes on production server:
  - UPDATE r_txs SET amount=r WHERE `payerFor` LIKE  '%fee%' AND amount=0 AND r=0.25;
  - DELETE FROM r_txs WHERE amount=0 AND data = 'a:0:{}' AND usdXid IS NOT NULL;
  - UPDATE r_txs SET type=-3 WHERE type=2;
  - UPDATE r_usd SET tid = NULL;
  - UPDATE  `r_usd` SET  `completed` =  '1389923856' WHERE  `r_usd`.`txid` =  '4418303';
  - UPDATE  `users` SET  `usd` =  '50.00' WHERE  `users`.`uid` =26742000000040;
  - remove r and usdXid fields from r_txs
  - eachAcct(); : renumbered bank transfers (tid field)
  - eachAcct() : $a->setBit(B_DW);
. added visible URL to invite email, so text-only recipients can see it.
. we can now give invitees simple verbal instructions to accept their invite without a link.
. changed invite time to 30 days
. removed "print sign-in card" from Relations page
. added "processing" spinner
. added "go back" button to help text for signup and community pages
. added r_invoices table

2014-01-08
. devices are now handled consistently and elegantly on Devices page
. firstUnusedId is used only for new users and works in all cases (r\acct::nextId() works fine)
. removed the "Create Agent Account" feature. 
. released held emails 
. invites are now allowed
. disabled Charge tab (until invoices are implemented properly)
. added serial id field to r_invites
. cleaned up r_boxes (added new int fields boxnum and channel before trying to reinstall)
. deleted all cashier accounts and fixed transactions that had those agents
. worked around Google Chrome bug that populates Company Phone field with user's phone, on signup
. invites now always come from agent
. multiple invite feature for admin only (uses William's info)
. fixed bug that showed negative returns on Summary page when average balance was negative (now shows infinite APR)
. admin and CGF company agents can see who is a member by clicking on a link on the Community page
. committed amount will never be displayed negative on Summary page
. temporarily disabled "charge" on SMS
. fixed bug in averageBalance function -- it was failing to include deposits/withdrawals (patched)

2013-12-31
. rPOS now handles default cashier (defaults to the company pro se)
. company permission to share rPOS with other companies is now implicit in CO_REQUIRE_CASHIER
. revamped gap finder as firstUnusedId function, but it has problems still (need tests)

2013-12-24
. new non-member cashiers got uid ZZZ.AAA etc (should be NEW.whatever). fixed.
. usd total is now cached for communities and regions (fixes a bug in pool in rcron)
. fixed two homogenize bugs (it was transferring USD to the least needy first, then continuing until exhausted and beyond)
. provided a link on relations page for member companies to print their own rPOS sign-in cards (no photo)
. fixed relations page formatting
. can now open another rCredits account before confirming bank deposits
. for admin, we no longer try to register an account with Dwolla when visiting the summary page (you must go to the status page instead)
. now we are notified by email whenever there are deposits or withdrawals
. new payment notices now show both physical and postalAddr and sometimes phone number, so member can ship or thank.
. administrator can now sign agreement for people and companies
. made averageBalance() more efficient and accurate by looping after a single query
. selecting "none of the above" on Open Another Account form now gives error message.
. fixed bug that kept setBank() from working
. fixed bug that allowed member "ready" status with no photo
. now accepts photos in several formats (PNG etc)
. verifyBy no longer defaults and is required
. fixed bug: PIN "0000" didn't work
. began changing rPOS interface to handle default cashiers

2013-12-05
. moved dwolla.php to rcredits folder
. changed how accounts form works so changing account and logging out always work right
. Membership tests now mostly work!
. fixed bug that kept dobs from getting recorded right
. change personal account opening process so last step is not required before person is a member
. began rsmart Exchange feature tests
. tweaked cron's homogenize1() so it trades USD for r only when inappropriate
. changed card code len to 14 (to avoid occasional complex QRs)
. fixed bug whereby Community page mistakenly showed rCredits as issued, that the community exchanged for USD
. non-code changes:
	- fixed dobs if not numeric (run eachAcct)
	- fixed data[verifyBy] to be if ('') SMS or (if 1 or not set) Voice (run eachAcct)
	- changed all @rcredits-org.com email addresses to @rc4.me (see util in admin.inc)
	- changed William's cardCode2 and printed him a new Company Agent card

2013-11-25
. restored addPhone(), accidentally deleted during separation of rweb-subs.inc from rweb.inc
. moved several functions back to rweb.inc from rweb-subs.inc that are called directly from URL
. implemented businessStructure parameter in Dwolla registration of companies
. eliminated "personal & commercial" account type (initial account is always personal)
. reworked homogenizing and pooling

2013-11-22
. all relevant tests pass
. added a notice that reward-sharing has been initiated (to precede the notice about it going through)
. got cron tests to pass again (given that nearly all transactions are in rCredits
. simplified formI and ScanCard tests to just go to rcredits.org or member page (for company cards)
. made the company cards say "Company Agent"
. non-code changes:
  - rename structure field "coFlags" in r_companies
  - create table r_boxes like r_boxnames; insert r_boxes select * from r_boxnames;
  - (no need to change fieldnames)
  - reinstall
  - delete r_smarts, r_boxnames after reinstall
  - add r_sms records to r_boxes (query?)
  - change all rebate pcts to 10
  - update dwolla.php

2013-11-19
. added Spendable: to the customer balance for rSmart
. expanded selling field to multiple lines
. expanded structure field to include miscellaneous company flags (renamed it coFlags)
. wrote all automated tests for rSmart (for the new rPOS) and they all pass!
. rWeb and rCron tests probably no longer work (address that next)

2013-10-28
. updated rsmart module to feed new POS app
. miscellaneous refactoring

2013-10-11
. created an admin tool and retrofited old accounts on prod server, recording dwollapin, dwollaphone, etc.
. changed r\quid to accept negative uids (quid is a single call to u\n2a() -- no dot)
. doubleclick (instead of single) on messages to make them vanish
. removed amount field from relations page
. admin can remove last manager from a company account or add one to a company with none
. clicking on photo no longer signs you out (patched on prod server)
. catch "you changed your password" and "you changed your email" emails from Dwolla (and disable the rC account with a misbehavior note in the data field)
. do transactions entirely in rCredits (even if the r balance goes negative). Distribute the USD evenly throughout the system (but with half in ctty account), for multiple cash-outs in one day.
. separated database function into rcredits-db.inc, namespace rCredits\DB (db)
. separated web subs into rweb-subs.inc
. added personal statistics to Summary page
. disabled soldOut function in cron (patched on production server)

2013-10-01
. don't list self as possible proxy
. tests expect tx rewards on entire amount, not just on the rCredits amount (r)
. no r% column
. no r/USD columns in download
. hover help on statistics page
. changed Bank setting to Bank Info
. added "skip" and "resume" to Gherkin
. added accountInfo step to dwolla and usd classes
. badDate function
. homogenize and pool functions in cron
. amount to withdraw in one day is limited to $10 from each other member
. gave bank transactions a tid (b#)
. transactions are now sorted (descending) by date, by tid before displaying

2013-09-22
. initialized stats on server: for ($dt = strtotime('5/23/2013'); $dt < time(); $dt += DAY_SECS) rCredits\getStats(-8915, $dt);
. made tests check for presence of labels on weShow, with, and without.
. allowed vertical arrays in tests
. disabled payment exchanges (virtual payments) in cron
. hid r% column and option to show/hide exchanges on Transactions page
. changed usd::source() to handle Dwolla's new practice of returning Dwolla balance as a source

2013-09-05
. changed physical field to postalAddr (and fixed data on production server)
. completed automation of dwolla account setup for companies
. fixed problems with show/hide javascripts
. created an "Agent Account" form
. fixed problems with Open Another Account
. PIN field now appears on Contact form ONLY if email changes
. on mobile, made messages absolute position. Any platform, click the message to dismiss it
. tell members they missed out on keeping their r (weekly) and give a clickable link to change their minimum to the suggested amount, without requiring signin
. fixed bug which made SCAN-only cashiers unable to sell (patched on production server)
. added an Undo tab (hidden except for mobile)
. settings gear omitted if no permission to manage account
. improved reports page drastically and renamed it "Statistics"
. started a separate rCredits-theme project (see) to accommodate Undo menu item on mobile interface

2013-09-02
. simplification of options when scanning a card; for example, never any "change acct" button on formI
. created form account/ssn
. created form account/kba
. "Not yet a member? <a>Check it out</a>!" on login
. members can scan their own card to sign in (just add pword)
. revised tests and usd class to use Dwolla sandbox effectively for testing
. added verification of AuthorizedRepresentative (for that Dwolla registration step of that name)
. passes all tests except Membership (tests need revision)

2013-08-30
. moved email (and email change) to contact form
. require pin instead of password, to change email
. moved password, pin, and photo change to their own pages, with links from security page
. fixed bug in misc.js that undid all check box clicks (patched on production server)
. added signout to account dropdown
. re-ordered settings categories
. changed r\go() to accept ordinary messages, not just errors
. renamed "Get r/USD" to "Bank"
. implemented bank addition and verification form
. bank form shows only last four digits of bank account number
. added committed amount to summary (on rewards line) "reserved for donations to CGF"
. fixed bug that hid charge tab for almost everyone
. implemented automatic phone, address, and ssn verification (for Dwolla account)
. fixed hiding of stuff on reg page as appropriate
. changed QR code format to allow longer cardcodes (expanded feature tests accordingly, to make sure old cards continue working)
- in formAccount did away with Drupal basis
- moved variable stuff from settings.php to boot.php
- improved forward.php to parse drupal messages and send html-formatted emails

2013-08-25
. fixed creditInfo() so it handles fee amounts properly (and displays right on Transactions page)
. fixed coverFee() so it creates a record in r_usd (and added missing reimbursements to production site)
. assured that summary page, transactions page, and downloads all show the same amounts
. fixed nextRBuyer bug (another bug) which mistakenly considered minimum balance (patched on production server)
. added an admin feature to cobble up a new account while waiting for the new dwolla reg api to be done
. system errors now email staff
. now gives error message if repeating the amount and other person as the previous transaction from same machine.
. fixed registration form javascript to show/hide fields depending on account type
. fixed coverFee bug (if Dwolla was unavailable, it queued the wrong function name) (patched on production server)
. fixed edit transaction purpose crash bug (patched on production server)
. adjusted settings.php, dwolla.php, and usd class to handle Dwolla sandbox self-signing certificate
. fixed tiny profile picture bug so user's photo now shows (patched on production server)
. eliminated tabs on login screen / separated registration and password change from dwolla builtin functions
. created new signup procedure, using Dwolla's new registration API (just the first step so far)
. changed calculator buttons to <button> and adjusted format to work on iPhones

2013-08-11
. fixed nextRBuyer bug, which chose the same member every time (patched on production server)
. fixed bankFollowup bug, which failed to mark transfers FROM bank completed (patched on production server and ran for each user, to fix data)
. shortened numeric keypad so it fits better on mobile screen (patched on production server)
. fixed bug that ran daily cron twice a day (patched on production server)
. fixed download bug (kept downloads from working at all)
. eliminated usdTid column in downloads
. everything uploaded to production server

2013-08-06
. changed "virtual payments" to "payment exchanges”
. Changed maximum bank delay to 10 days.  Patched on production server. Fixes double bank withdrawal bug. 
. City and state zip code without using USPS API 
. Icons on settings page 

2013-07-29
- Option to use internal Dwolla sandbox (including changes to settings.php and dwolla.php)
- calculator for mobile amount entry
- simplified mobile header, menus, global links, and help
- fixed mobile formatting on Preferences page
- added addBank() and verifyBank() to usd class

2013-07-11
- scan permission
- popup help throughout Transaction History page
- handle lost USD deposits/withdrawals/fees
- monthly inflation adjustment (and tests)
- sharing rewards with CGF (and tests)

2013-07-05
- added optional box column to Transaction History
- changed companies field "id" to "uid" (for consistency)
- new password not required after "Request New Password" if user logs in with valid old

2013-07-04
- changed values of tx types (needs to be updated in production database)
- added "From Bank" and "Fees" to Transaction History
- all Dwolla fees will now be reimbursed by the community (unless reimbursed by Dwolla). This also fixes problems with accurate USD balance caching
- fixed bug in r\nextRBuyer() that prevented members from buying rCredits if they had transactions but had never traded USD for rCredits (patched on production server)