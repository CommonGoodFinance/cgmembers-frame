<?php
//
// Feature: Pilot
//   AS a group of pioneering members
//   I WANT the first few transactions of the pilot phase to go as expected
//   SO I will have confidence to continue using the rCredits system.

require_once __DIR__ . '/../../../gherkin/test-defs.php';
require_once __DIR__ . '/../rcron.steps';

class rcronPilot extends DrupalWebTestCase {
  var $subs; // percent parameters (to Given(), etc.) and their replacements (eg: %random1 becomes some random string)
  var $sceneName;
  const SHORT_NAME = 'Pilot';
  const FEATURE_NAME = 'rcron Test - Pilot';
  const DESCRIPTION = 'Pilot';
  const MODULE = 'rcron';

  public function gherkin($statement, $type) {
    $this->assertTrue(gherkinGuts($statement, $type), $statement, $this->sceneName);
  }
  
  public static function getInfo() {
    return array(
      'short_name' => self::SHORT_NAME,
      'name' => self::FEATURE_NAME,
      'description' => self::DESCRIPTION,
      'group' => ucwords(self::MODULE)
    );
  }

  public function setUp() {} // must be compatible with DrupalWebTestCase::setUp()
  
  public function setUp2($sceneName, $variant = '') {
    global $sceneTest; $sceneTest = $this;
    parent::setUp(self::MODULE);

    $this->subs = usualSubs();
    $this->sceneName = __FUNCTION__;
    if (function_exists('extraSetup')) extraSetup($this); // defined in rcron.steps
    $this->sceneName = $sceneName;

    switch ($variant) {
    default: // fall through to case(0)
    case(0):
    Then_('members: "DATA'
    . '\\| id   | fullName            | flags                      |'
    . '\\| .AAA | William Spademan    | dft,ok,personal,bona       |'
    . '\\| .AAB | Common Good Finance | dft,ok,company,charge,bona |"');
    Given('members: "DATA'
    . '\\| id   | fullName   | email | flags                         |'
    . '\\| .AAF | John Eich  | f@ex  | dft,ok,personal               |'
    . '\\| .AAG | Alden B    | g@ex  | dft,ok,personal               |'
    . '\\| .AAH | Becca King | h@ex  | dft,ok,personal               |'
    . '\\| .AAI | Barbara F  | i@ex  | dft,ok,personal               |'
    . '\\| .AAJ | Julia E    | j@ex  | dft,ok,personal               |'
    . '\\| .AAK | Gary S     | k@ex  | dft,ok,personal               |'
    . '\\| .AAL | Diane M    | l@ex  | dft,ok,personal               |'
    . '\\| .AAM | Peter L    | m@ex  | dft,ok,personal               |'
    . '\\| .AAO | Nancy H    | o@ex  | dft,ok,personal               |'
    . '\\| .AAQ | Snow\'s     | q@ex  | dft,ok,company,charge         |'
    . '\\| .AAR | Pint       | r@ex  | dft,ok,company,charge         |'
    . '\\| .AAS | GFM        | s@ex  | dft,ok,company,charge         |"');
    And__('balances: "DATA'
    . '\\| id   | r | usd | rewards | minimum | share | committed |'
    . '\\| .AAA | 0 | 200 |       0 |     200 |    50 |         0 |'
    . '\\| .AAB | 0 |   0 |       0 |       0 |     0 |         0 |'
    . '\\| .AAF | 0 |   0 |       0 |     200 |     1 |         0 |'
    . '\\| .AAG | 0 | 200 |       0 |     200 |    50 |         0 |'
    . '\\| .AAH | 0 | 100 |       0 |     100 |    10 |         0 |'
    . '\\| .AAI | 0 |   0 |       0 |      50 |    50 |         0 |'
    . '\\| .AAJ | 0 |  20 |       0 |      20 |    10 |         0 |'
    . '\\| .AAK | 0 |   0 |       0 |      50 |    25 |         0 |'
    . '\\| .AAL | 0 |   5 |       0 |       0 |     0 |         0 |'
    . '\\| .AAM | 0 | 100 |       0 |     100 |    50 |         0 |'
    . '\\| .AAO | 0 | 200 |       0 |     200 |   100 |         0 |'
    . '\\| .AAQ | 0 |   0 |       0 |      10 |    25 |         0 |'
    . '\\| .AAR | 0 |   0 |       0 |     200 |   100 |         0 |'
    . '\\| .AAS | 0 |   0 |       0 |     200 |     2 |         0 |"');
    And__('relations: "DATA'
    . '\\| id   | main | agent | draw | amount | employerOk | employeeOk | isOwner | permission |'
    . '\\| .AAB | .AAB | .AAA  |    0 |   1000 |          0 |          0 |       0 | manage     |'
    . '\\| .AAD | .AAQ | .AAK  |    1 |    100 |          1 |          0 |       1 | manage     |'
    . '\\| .AAE | .AAK | .AAQ  |    1 |      0 |          0 |          0 |       0 |            |'
    . '\\| .AAF | .AAQ | .AAI  |    1 |    100 |          1 |          0 |       1 | manage     |'
    . '\\| .AAI | .AAR | .AAG  |    0 |   3000 |          1 |          0 |       1 | manage     |'
    . '\\| .AAJ | .AAR | .AAQ  |    0 |    500 |          0 |          0 |       0 |            |'
    . '\\| .AAK | .AAS | .AAF  |    0 |    100 |          1 |          1 |       0 | manage     |'
    . '\\| .AAL | .AAS | .AAL  |    0 |     10 |          1 |          0 |       0 | sell       |'
    . '\\| .AAM | .AAS | .AAJ  |    0 |     10 |          1 |          0 |       0 | manage     |"');
    And__('gifts: "DATA'
    . '\\| id   | amount | often | giftDate   |'
    . '\\| .AAA |     50 |     1 |          0 |'
    . '\\| .AAF |     50 |     1 |          0 |'
    . '\\| .AAG |      5 |     1 |          0 |'
    . '\\| .AAH |     50 |     1 |          0 |'
    . '\\| .AAI |     10 |     1 |          0 |'
    . '\\| .AAJ |     25 |     1 |          0 |'
    . '\\| .AAK |    100 |     1 |          0 |'
    . '\\| .AAL |      1 |     M | 1367937541 |'
    . '\\| .AAM |    100 |     1 |          0 |'
    . '\\| .AAO |    100 |     1 |          0 |'
    . '\\| .AAQ |     50 |     1 |          0 |'
    . '\\| .AAR |      5 |     1 |          0 |'
    . '\\| .AAS |     50 |     1 |          0 |"');
    When_('transactions: "DATA'
    . '\\| xid | created   | type      | state | amount | r    | from | to   | purpose      | taking |'
    . '\\|   1 | %today-8d | signup    | done  |     20 |   20 | ctty | .AAA | signup       | 0      |"');
    Then_('balances: "DATA'
    . '\\| id   | r  | usd | rewards | minimum | maximum | share | committed |'
    . '\\| .AAA | 20 | 200 |      20 |     200 |      -1 |    50 |         0 |"');
    break;


    }
  }

  // Scenario: all
  public function testAll_0() {
    $this->setUp2(__FUNCTION__, 0);
    When_('member ".AAS" charges member ".AAA" $40 for "groceries"');
    Then_('transactions: "DATA'
    . '\\| xid | created | type      | state | amount | r    | from | to   | purpose      | taking |'
    . '\\|   2 | %today  | transfer  | done  |     40 |   20 | .AAA | .AAS | groceries    |      1 |'
    . '\\|   3 | %today  | rebate    | done  |      1 |    1 | ctty | .AAA | rebate on #2 |      0 |'
    . '\\|   4 | %today  | bonus     | done  |      2 |    2 | ctty | .AAS | bonus on #1  |      0 |"');
    And__('balances: "DATA'
    . '\\| id   | r  | usd | rewards | minimum | maximum | share | committed |'
    . '\\| .AAA |  1 | 180 |      21 |     200 |      -1 |    50 |      0.50 |"');
    When_('cron runs "ALL"');
    Then_('transactions: "DATA'
    . '\\| xid | created   | type      | state | amount | r    | from | to   | purpose      | taking |'
    . '\\|   5 | %today    | signup    | done  |     20 |   20 | ctty | .AAG | signup       | 0      |'
    . '\\|   6 | %today    | signup    | done  |     20 |   20 | ctty | .AAH | signup       | 0      |'
    . '\\|   7 | %today    | signup    | done  |     20 |   20 | ctty | .AAJ | signup       | 0      |'
    . '\\|   8 | %today    | signup    | done  |     20 |   20 | ctty | .AAL | signup       | 0      |'
    . '\\|   9 | %today    | signup    | done  |     20 |   20 | ctty | .AAM | signup       | 0      |'
    . '\\|  10 | %today    | signup    | done  |     20 |   20 | ctty | .AAO | signup       | 0      |"');
    And__('transactions: "DATA'
    . '\\| xid | created   | type      | state | amount | r    | from | to   | purpose      | taking |'
    . '\\|  11 | %today    | transfer  | done  |     50 |    1 | .AAA | .AAB | contribution | 0      |'
    . '\\|  12 | %today    | rebate    | done  |   2.50 | 2.50 | ctty | .AAA | rebate on #3 | 0      |'
    . '\\|  13 | %today    | bonus     | done  |      5 |    5 | ctty | .AAB | bonus on #1  | 0      |'
    . '\\|  14 | %today    | transfer  | done  |      5 |    5 | .AAG | .AAB | contribution | 0      |'
    . '\\|  15 | %today    | rebate    | done  |   0.25 | 0.25 | ctty | .AAG | rebate on #2 | 0      |'
    . '\\|  16 | %today    | bonus     | done  |   0.50 | 0.50 | ctty | .AAB | bonus on #2  | 0      |'
    . '\\|  17 | %today    | transfer  | done  |     50 |   20 | .AAH | .AAB | contribution | 0      |'
    . '\\|  18 | %today    | rebate    | done  |   2.50 | 2.50 | ctty | .AAH | rebate on #2 | 0      |'
    . '\\|  19 | %today    | bonus     | done  |      5 |    5 | ctty | .AAB | bonus on #3  | 0      |'
    . '\\|  20 | %today    | transfer  | done  |     25 |   20 | .AAJ | .AAB | contribution | 0      |'
    . '\\|  21 | %today    | rebate    | done  |   1.25 | 1.25 | ctty | .AAJ | rebate on #2 | 0      |'
    . '\\|  22 | %today    | bonus     | done  |   2.50 | 2.50 | ctty | .AAB | bonus on #4  | 0      |'
    . '\\|  23 | %today    | transfer  | done  |      1 |    1 | .AAL | .AAB | contribution | 0      |'
    . '\\|  24 | %today    | rebate    | done  |   0.05 | 0.05 | ctty | .AAL | rebate on #2 | 0      |'
    . '\\|  25 | %today    | bonus     | done  |   0.10 | 0.10 | ctty | .AAB | bonus on #5  | 0      |'
    . '\\|  26 | %today    | transfer  | done  |    100 |   20 | .AAM | .AAB | contribution | 0      |'
    . '\\|  27 | %today    | rebate    | done  |      5 |    5 | ctty | .AAM | rebate on #2 | 0      |'
    . '\\|  28 | %today    | bonus     | done  |     10 |   10 | ctty | .AAB | bonus on #6  | 0      |'
    . '\\|  29 | %today    | transfer  | done  |    100 |   20 | .AAO | .AAB | contribution | 0      |'
    . '\\|  30 | %today    | rebate    | done  |      5 |    5 | ctty | .AAO | rebate on #2 | 0      |'
    . '\\|  31 | %today    | bonus     | done  |     10 |   10 | ctty | .AAB | bonus on #7  | 0      |"');
    And__('usd transfers: "DATA'
    . '\\| payer | amount  | payee |'
    . '\\| .AAA  |   20.00 | .AAS  |'
    . '\\| .AAA  |   49.00 | .AAB  |'
    . '\\| .AAH  |   30.00 | .AAB  |'
    . '\\| .AAJ  |    5.00 | .AAB  |'
    . '\\| .AAM  |   80.00 | .AAB  |'
    . '\\| .AAO  |   80.00 | .AAB  |'
    . '\\| .AAA  |  -66.50 |    0  |'
    . '\\| .AAF  | -200.00 |    0  |'
    . '\\| .AAH  |  -27.50 |    0  |'
    . '\\| .AAI  |  -50.00 |    0  |'
    . '\\| .AAJ  |   -4.00 |    0  |'
    . '\\| .AAK  |  -50.00 |    0  |'
    . '\\| .AAM  |  -75.00 |    0  |'
    . '\\| .AAO  |  -75.00 |    0  |'
    . '\\| .AAQ  |  -10.00 |    0  |'
    . '\\| .AAR  | -200.00 |    0  |'
    . '\\| .AAS  | -158.25 |    0  |"');
  }

}