<?php
//
// Feature: Pilot
//   AS a group of pioneering members
//   I WANT the first few transactions of the pilot phase to go as expected
//   SO I will have confidence to continue using the rCredits system.

require_once __DIR__ . '/../../../gherkin/test-defs.php';
require_once __DIR__ . '/../rcron.steps';

class rcronPilot extends DrupalWebTestCase {
  var $subs; // percent parameters (to Given(), etc.) and their replacements (eg: %random1 becomes some random string)
  var $sceneName;
  const SHORT_NAME = 'Pilot';
  const FEATURE_NAME = 'rcron Test - Pilot';
  const DESCRIPTION = 'Pilot';
  const MODULE = 'rcron';

  public function gherkin($statement, $type) {
    $this->assertTrue(gherkinGuts($statement, $type), $statement, $this->sceneName);
  }
  
  public static function getInfo() {
    return array(
      'short_name' => self::SHORT_NAME,
      'name' => self::FEATURE_NAME,
      'description' => self::DESCRIPTION,
      'group' => ucwords(self::MODULE)
    );
  }

  public function setUp() {} // must be compatible with DrupalWebTestCase::setUp()
  
  public function setUp2($sceneName, $variant = '') {
    global $sceneTest; $sceneTest = $this;
    parent::setUp(self::MODULE);

    $this->subs = usualSubs();
    $this->sceneName = __FUNCTION__;
    if (function_exists('extraSetup')) extraSetup($this); // defined in rcron.steps
    $this->sceneName = $sceneName;

    switch ($variant) {
    default: // fall through to case(0)
    case(0):
    Then_('members: "DATA'
    . '\\| id   | fullName            | flags                      |'
    . '\\| .AAA | William Spademan    | dft,ok,personal,bona       |'
    . '\\| .AAB | Common Good Finance | dft,ok,company,charge,bona |"');
    Given('members: "DATA'
    . '\\| id   | fullName   | email | flags                         |'
    . '\\| .AAD | John Root  | d@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAE | Janet H    | e@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAF | John Eich  | f@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAG | Alden B    | g@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAH | Becca King | h@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAI | Barbara F  | i@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAJ | Julia E    | j@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAK | Gary S     | k@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAL | Diane M    | l@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAM | Peter L    | m@ex  | dft,ok,personal               |'
    . '\\| .AAO | Nancy H    | o@ex  | dft,ok,personal,to_bank       |'
    . '\\| .AAQ | Snow\'s     | q@ex  | dft,ok,company,charge         |'
    . '\\| .AAR | Pint       | r@ex  | dft,ok,company,charge,to_bank |'
    . '\\| .AAS | GFM        | s@ex  | dft,ok,company,charge,to_bank |"');
    And__('balances: "DATA'
    . '\\| id   | r | usd | rewards | minimum | maximum | share | committed |'
    . '\\| .AAA | 0 | 200 |       0 |     200 |       0 |    50 |         0 |'
    . '\\| .AAB | 0 |   0 |       0 |       0 |       0 |     0 |         0 |'
    . '\\| .AAD | 0 | .20 |       0 |     200 |       0 |    50 |         0 |'
    . '\\| .AAE | 0 |   0 |       0 |      10 |      50 |    10 |         0 |'
    . '\\| .AAF | 0 |   0 |       0 |     200 |       0 |     1 |         0 |'
    . '\\| .AAG | 0 |   0 |       0 |     200 |       0 |    50 |         0 |'
    . '\\| .AAH | 0 | 100 |       0 |     100 |       0 |    10 |         0 |'
    . '\\| .AAI | 0 |   0 |       0 |      50 |     100 |    50 |         0 |'
    . '\\| .AAJ | 0 |  20 |       0 |      20 |      50 |    10 |         0 |'
    . '\\| .AAK | 0 |   0 |       0 |      50 |     100 |    25 |         0 |'
    . '\\| .AAL | 0 |   0 |       0 |       0 |      20 |     0 |         0 |'
    . '\\| .AAM | 0 | 100 |       0 |     100 |       0 |    50 |         0 |'
    . '\\| .AAO | 0 | 200 |       0 |     200 |     200 |   100 |         0 |'
    . '\\| .AAQ | 0 |   0 |       0 |      10 |       0 |    25 |         0 |'
    . '\\| .AAR | 0 |   0 |       0 |     200 |       0 |   100 |         0 |'
    . '\\| .AAS | 0 |   0 |       0 |     200 |    1000 |     2 |         0 |"');
    And__('relations: "DATA'
    . '\\| id   | main | agent | draw | amount | employerOk | employeeOk | isOwner | permission |'
    . '\\| .AAB | .AAB | .AAA  |    0 |   1000 |          0 |          0 |       0 | manage     |'
    . '\\| .AAD | .AAQ | .AAK  |    1 |    100 |          1 |          0 |       1 | manage     |'
    . '\\| .AAE | .AAK | .AAQ  |    1 |      0 |          0 |          0 |       0 |            |'
    . '\\| .AAF | .AAQ | .AAI  |    1 |    100 |          1 |          0 |       1 | manage     |'
    . '\\| .AAI | .AAR | .AAG  |    0 |   3000 |          1 |          0 |       1 | manage     |'
    . '\\| .AAJ | .AAR | .AAQ  |    0 |    500 |          0 |          0 |       0 |            |'
    . '\\| .AAK | .AAS | .AAF  |    0 |    100 |          1 |          1 |       0 | manage     |'
    . '\\| .AAL | .AAS | .AAL  |    0 |     10 |          1 |          0 |       0 | sell       |'
    . '\\| .AAM | .AAS | .AAJ  |    0 |     10 |          1 |          0 |       0 | manage     |"');
    And__('gifts: "DATA'
    . '\\| id   | amount | often | giftDate   |'
    . '\\| .AAA |     50 |     1 |          0 |'
    . '\\| .AAD |     50 |     1 |          0 |'
    . '\\| .AAE |     25 |     1 |          0 |'
    . '\\| .AAF |     50 |     1 |          0 |'
    . '\\| .AAG |      5 |     1 |          0 |'
    . '\\| .AAH |     50 |     1 |          0 |'
    . '\\| .AAI |     10 |     1 |          0 |'
    . '\\| .AAJ |     25 |     1 |          0 |'
    . '\\| .AAK |    100 |     1 |          0 |'
    . '\\| .AAL |      1 |     M | 1367937541 |'
    . '\\| .AAM |    100 |     1 |          0 |'
    . '\\| .AAO |    100 |     1 |          0 |'
    . '\\| .AAQ |     50 |     1 |          0 |'
    . '\\| .AAR |      5 |     1 |          0 |'
    . '\\| .AAS |     50 |     1 |          0 |"');
    break;


    }
  }

  // Scenario: cron runs for the first time
  public function testCronRunsForTheFirstTime_0() {
    $this->setUp2(__FUNCTION__, 0);
    When_('cron runs "ALL"');
    Then_('transactions: "DATA'
    . '\\| xid | created | type      | state | amount | r    | from | to   | purpose      | taking |'
    . '\\| 1   | %today  | signup    | done  |     20 |   20 | ctty | .AAD | signup       | 0      |'
    . '\\| 2   | %today  | signup    | done  |     20 |   20 | ctty | .AAH | signup       | 0      |'
    . '\\| 3   | %today  | signup    | done  |     20 |   20 | ctty | .AAJ | signup       | 0      |'
    . '\\| 4   | %today  | signup    | done  |     20 |   20 | ctty | .AAM | signup       | 0      |'
    . '\\| 5   | %today  | signup    | done  |     20 |   20 | ctty | .AAO | signup       | 0      |'
    . '\\| 6   | %today  | transfer  | done  |     50 |    0 | .AAA | .AAB | contribution | 0      |'
    . '\\| 7   | %today  | rebate    | done  |   2.50 | 2.50 | ctty | .AAA | rebate on #1 | 0      |'
    . '\\| 8   | %today  | bonus     | done  |   5.00 | 5.00 | ctty | .AAB | bonus on #1  | 0      |'
    . '\\| 9   | %today  | transfer  | done  |  50.00 |   20 | .AAH | .AAB | contribution | 0      |'
    . '\\| 10  | %today  | rebate    | done  |   2.50 | 2.50 | ctty | .AAH | rebate on #2 | 0      |'
    . '\\| 11  | %today  | bonus     | done  |   5.00 | 5.00 | ctty | .AAB | bonus on #2  | 0      |'
    . '\\| 12  | %today  | transfer  | done  |  25.00 |   20 | .AAJ | .AAB | contribution | 0      |'
    . '\\| 13  | %today  | rebate    | done  |   1.25 | 1.25 | ctty | .AAJ | rebate on #2 | 0      |'
    . '\\| 14  | %today  | bonus     | done  |   2.50 | 2.50 | ctty | .AAB | bonus on #3  | 0      |'
    . '\\| 15  | %today  | transfer  | done  | 100.00 |   20 | .AAM | .AAB | contribution | 0      |'
    . '\\| 16  | %today  | rebate    | done  |   5.00 | 5.00 | ctty | .AAM | rebate on #2 | 0      |'
    . '\\| 17  | %today  | bonus     | done  |     10 |   10 | ctty | .AAB | bonus on #4  | 0      |'
    . '\\| 18  | %today  | transfer  | done  | 100.00 |   20 | .AAO | .AAB | contribution | 0      |'
    . '\\| 19  | %today  | rebate    | done  |   5.00 | 5.00 | ctty | .AAO | rebate on #2 | 0      |'
    . '\\| 20  | %today  | bonus     | done  |     10 |   10 | ctty | .AAB | bonus on #5  | 0      |"');
    And__('bank transfers: "DATA'
    . '\\| payer | amount  |'
    . '\\| .AAA  |  -47.50 |'
    . '\\| .AAD  | -179.80 |'
    . '\\| .AAH  |  -47.50 |'
    . '\\| .AAE  |  -10.00 |'
    . '\\| .AAF  | -200.00 |'
    . '\\| .AAG  | -200.00 |'
    . '\\| .AAI  |  -50.00 |'
    . '\\| .AAK  |  -50.00 |'
    . '\\| .AAM  |  -85.00 |'
    . '\\| .AAO  |  -85.00 |'
    . '\\| .AAQ  |  -10.00 |'
    . '\\| .AAR  | -200.00 |'
    . '\\| .AAS  | -200.00 |"');
  }

}