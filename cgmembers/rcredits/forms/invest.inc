<?php
namespace CG\Web;
use CG\Web as w;
use CG as r;
use CG\Backend as be;
use CG\Util as u;
use CG\Db as db;

/**
 * Join an investment club or manage membership therein.
 */
function formInvest($form, &$sta, $args) {
  global $mya; $uid = $mya->id;

  $title = t('Investment Club');
  
  if (!$clubid = $mya->iclubid) {
    $subtext = t('There is no investment club in your community at this time. Consider starting one! Your %PROJECT community administrator can set it up for you.');
    return cgform(compact(ray('title subtext')));
  }

  $clubVal0 = clubVal($investments0, $liquid0, $reserve0);
  $buttons0 = btn("/invest/list/clubid=$clubid", t('List Investments'), 'success');
  
  if ($mya->isIClub) { // the club itself
    $buttons = $buttons0
      . btn("/invest/propose/clubid=$clubid", t('Propose'))
		  . btn("/invest/cashout/clubid=$clubid", t('Requests to Cash Out'));
    $count0 = db\get('COUNT(DISTINCT uid)', 'r_stakes', compact('clubid'));
    $count = item(number_format($count0), t('Member Count:'));
		$investments = item(u\fmtAmt($investments0), t('Investments:'));
		$liquid = item(u\fmtAmt($liquid0), t('Liquid:'));
		$reserve = textFld(t('Loss/Expense Reserve:'), '', required(u\fmtAmt($reserve0)));
		$clubVal = item(u\fmtAmt($clubVal0), t('Club Net Value:'));
    $submit = t('Save');
  } elseif ($isMember = $res = db\get('*', 'r_stakes', compact(ray('uid clubid')))) { // member!
    extract(just('request stake', $res));
//    extract(just('stake', $res));
//		$request = db\sum('amount', 'r_invoices', 'status=:TX_PENDING AND payer=:clubid AND payee=:uid', compact('clubid', 'uid'));
    $old = hidFld(serialize(just('stakeid clubid stake request requestedOut', $res)));
    $request += 0; // enable if($request)
    $stake += 0;
    $buttons = $buttons0;
    $amount = textFld($stake ? t('Buy or sell:') : t('Invest:'), [t('Amount'), t('If you reduce your investment amount, it will take effect when funds become available.') . $request ? t('  Whatever amount you request here will be in addition to your current request.') : ''], required()); // must be before request item
    $myRequest = $request ? item(u\fmtAmt($request, ''), t('Change request:'), t('Your pending request to %change your investment', 'change', $request < 0 ? t('reclaim part of') : t('increase'))) : NULL;
//    $togAttrs = ray('on off offstyle', t('Sell'), t('Buy'), 'warning');
//    $buyorsell = togFld('buysell', t('Buy or Sell:'), '', 1, $togAttrs);
    $buy = submi(t('Invest MORE'), '', 'md');
    if ($stake or $request) $sell = submi(t('Invest LESS'), '', 'md');
    //$myStake = item(u\fmtAmt($stake, ''), t('Your investment:'));
		$myVal0 = myClubVal($clubVal0);
		$pct = $clubVal0 ? $myVal0 / $clubVal0 : 0;
		$clubVal = item(t('%val (%liquid liquid)', 'val liquid', u\fmtAmt($clubVal0), u\fmtAmt($liquid0)), t('Club Value:'));
		$myShare = item(tr('%amt (%pct)', 'amt pct', u\fmtAmt($myVal0), u\fmtAmt($pct, '%')), t('Your Share:'));
    $submit = fieldSet('submit2', @compact('buy', 'sell'), ' ');
  } else { // not a member yet
    $old = hidFld(serialize(compact('clubid')));
    $title = t('Join Your Local Investment Club');
    $subtext = t(<<< X
  <p>Yes, I want to join the %cttyName Investment Club (the Club). I agree to the Club's <%a>Partnership Agreement</a>. In particular:</p>
  <ol><li>I recognize my investment is at risk. I may not be able to reclaim it right away and may <i>lose</i> some or all of it.</li>
  <li>I agree to participate actively in overseeing the Club's investments &mdash; at a minimum by voting on the proposed investments each calendar quarter (voting directly, not by proxy).</li>
  </ol>
X
    , 'cttyName _a', $mya->cttyA->fullName, atag('http://partnershipLink'));
    $signedBy = w\signedBy();
    $submit = t('Join');
  }

  return cgform(@compact(ray('title subtext buttons signedBy old count investments liquid reserve clubVal myShare myRequest amount submit')));
}

function formInvest_validate($form, &$sta) {
  global $mya;

  extract(just('signedBy amount old reserve', $sta['input']));

  if (isset($signedBy)) return !w\badSignature($sta);
  
  if (isset($reserve)) {
    if ($err = u\badAmount($reserve)) return say($err, 'reserve');
    return;
  }
  
 // buy or sell
  if ($err = u\badAmount($amount, '>0')) return say($err, 'amount');
  extract(just('request stake', unserialize($old)));

  if (op($sta) == 'buy') {
    if (@$request + $amount > 0 and $short = $mya->shortfall(FOR_USD, @$request + $amount)) {
      if (!$mya->hasBank) return say(t('You are %short short for that investment.', 'short', u\fmtAmt($short)), 'amount');
      $sta['input']['short'] = $short;
    }
  } elseif ($stake + @$request - $amount < 0) return say(t('That is more than you have invested!'), 'amount');
}

function formInvest_submit($form, &$sta) {
  global $mya;
  extract(just('signedBy old amount short reserve', $sta['input']));
  
  if (@$signedBy) {
    extract(just('clubid', unserialize($old)));
    db\insert('r_stakes', ray('uid clubid joined', $mya->id, $clubid, time()), 'stakeid');
    return say(t('You are now a member of the club!'));
  }

  if (isset($reserve)) {
    u\EXPECT($mya->id == $mya->iclubid, 'setting reserve when not club');
    $mya->update('minimum', $reserve);
    return say(t('info saved'));
  }
  
  // buy or sell  
  extract(just('stakeid clubid stake request requestedOut', unserialize($old)));
  $buy = (op($sta) == 'buy');
  $request = round($request + ($buy ? $amount : -$amount), 2);
	if (!$buy) $requestedOut = NOW;
  db\update('r_stakes', compact(ray('stakeid request requestedOut')), 'stakeid');
  
  if ($buy and $request > 0) {
    if (@$short) {
      $msg = t('You do not currently have enough funds in your %PROJECT account for that investment, so %short will be drawn automatically from your bank account. Once that transfer is complete, your requested investment will be made automatically.', 'short', u\fmtAmt($short));
      $mya->getFunds($short, t('for investment'));
    } else r\handleInvestmentRequest($stakeid, $msg);
  } elseif (!$buy and $request < 0) { // sell
		$msg = t('Your request to redeem %request of your investment will be handled by a club administrator when funds become available.', 'request', u\fmtAmt(-$request));
	} else $msg = t('Your request has been adjusted accordingly.');

  say($msg);
}

//		list ($msg, $subs) = be\invoice($mya, r\acct($mya->iclubid), $amount, t('redeem investment'), ray('goods stakeid', FOR_STAKE, $stakeid));
//		say($msg, $subs);

/**
 * Return the investment club's total current value.
 * @param numeric $investments: (RETURNED) value of club's investments
 * @param numeric $liquid: (RETURNED) club's cash assets (including reserve)
 * @param numeric $reserve: (RETURNED) club's cash reserve
 */
function clubVal(&$investments = 0, &$liquid = 0, &$reserve = 0) {
	global $mya;
	$clubid = $mya->iclubid;
	$icA = r\acct($clubid);
	$investments = db\sum('shares*price', 'r_shares s JOIN r_investments i ON i.vestid=s.vestid', ray('clubid', $clubid));
	list ($liquid, $reserve) = [$icA->balance, $icA->minimum];
	return round($liquid - $reserve + $investments, 2); // cash less reserve plus investments
}

/**
 * Return the value of the current account's investment in the club.
 * A CG member who is not a club member can represent their spouse at a club meeting, but there is no joint investment account.
 * @param numeric $icVal: club's total current value
 */
function myClubVal($clubVal) {
  global $mya;
	$stake = 'amount'; // 'IF(payer.uid=:clubid,-amount,amount)';
	$share = "(:NOW-created)*$stake";
	$sql = <<<X
	  SELECT SUM($stake) AS totalStake,
           SUM(IF(e.uid=:myid, $stake, 0)) AS myStake
	  FROM tx_hdrs t JOIN tx_entries e USING(xid)
    WHERE e.uid=:clubid AND :IS_STAKE
X;
  extract(db\q($sql, ray('myid clubid', $mya->id, $mya->iclubid))->fetchAssoc());
	return round($myStake, 2);
}