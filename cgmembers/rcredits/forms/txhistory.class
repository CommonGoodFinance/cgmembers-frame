<?php
namespace CG\Web;
use CG\Web as w;
use CG as r;
use CG\DB as db;
use CG\Backend as be;
use CG\Util as u;

require_once __DIR__ . '/txprocessor.interface';

/**
 * @file
 * Class to generate transaction history reports; extends 
 *
 */

class TxHistory implements TxProcessor {
  private $body = '';
  private $uids = [];
  private $tidValue = '';
  private $dateValue = '';
  private $count = 0;
  private $runBalance = 0;
  private $baseUrl = null;
  
  public function __construct($uids, $baseUrl) {
    $this->uids = $uids;
    $this->baseUrl = $baseUrl;
  }
  
  /**
   * Called before the first transaction.
   */
  public function hdr() {
    /* global $mya, $agtViaBoxHelp; */


    /* $helpFields = 'tid date state purpose name amount fromyou toyou buttons net' . (@$agtViaBoxHelp ? ' agent channel box' : ''); */

    /* $headHelp = array_combine(ray($helpFields), ray($headHelp)); */
    /* $classes = 'tid date name purpose amount fromyou toyou net buttons'; */
    /* $headers = t('Tx#,Date,Name,Purpose,Amount,From You, To You,Net,Action'); */
    
    /* $header = array_combine(ray($classes), ray($headers)); // make splices and additions easy and clear */
    /* if (@$agents) $header['agent'] = t('Agent'); */
    /* if (@$channels) $header['channel'] = t('Via'); */
    /* if (@$boxes) $header['box'] = t('Box'); */
    
    /* foreach ($header as $cls => $hdr) $header[$cls] = w\popHelp($hdr, $headHelp[$class]); */
    
    /* return array(array_keys($header), array_values($header), @array_values($downloadHeader)); */
    
    $tid = w\popHelp(t('Tx#'), t('Transaction number'));
    $date = w\popHelp(t('Date'), t('Date transaction was completed'));
    $name = w\popHelp(t('Name'), t('Who did you pay or receive from'));
    $purpose = w\popHelp(t('Purpose'), t('What is the purpose of the transaction (usually the item or service purchased)'));
    $amount = w\popHelp(t('Amount'), t('Amounts you spent or received'));
    /* $fromyou = w\popHelp(t('From You'), t('fromyou')); */
    /* $toyou = w\popHelp(t('To You'), t('toyou')); */
    /* $net = w\popHelp(t('Net'), t('The net change in account balance')); */
    $runBalance = w\popHelp(t('Balance'), t('The balance in the account after this transaction'));
    $buttons = w\popHelp(t('Action'), t('Click a symbol to reverse a transaction'));
    
    $this->body = <<<EOF
<div id="txlist" class="table table-striped">
  <div id="txs-links" class="row">
    <div class="showMore col-xs-3">
      <a title="Show more transactions per page"><span class="glyphicon glyphicon-plus"></span>Show more</a>
    </div>
    <div class="dates col-xs-2">
      <a title="Select dates to show"><span class="glyphicon glyphicon-calendar"></span>Dates</a>
    </div>
    <div class="download col-xs-3">
      <a title="Select dates and download as CSV file"><span class="glyphicon glyphicon-download-alt"></span>Download</a>
    </div>
    <div class="totals col-xs-2">
      <a data-toggle="modal" data-target="#txs-totals" title="Show totals for the selected period"><span class="glyphicon glyphicon-usd"></span>Totals</a>
    </div>
    <div class="nav col-xs-1">
      <a class="prevPage" title="Previous Page"><span class="glyphicon glyphicon-triangle-left"></span></a>
      <a class="nextPage" title="Next Page"><span class="glyphicon glyphicon-triangle-right"></span></a>
    </div>
  </div>
  <div class="row txRow head page--1 PAGE--1">
    <div class="tid-date col-xs-2">
      <div class="tid col-sm-5">$tid</div>
      <div class="date col-sm-7">$date</div>
    </div>
    <div class="name-purpose col-xs-6">
      <div class="name col-sm-6">$name</div>
      <div class="purpose col-sm-6">$purpose</div>
    </div>
    <div class="amount-reward col-xs-3">
      <div class="amount col-sm-5">$amount</div>
      <div class="runBalance col-sm-7">$runBalance</div>
    </div>
    <div class="buttons col-xs-1">$buttons</div>
  </div>
EOF;
  }

  /**
   * Called before each transaction.
   * @param assoc $info: all of the data for this entry (includes transaction data)
   */
  public function txnHdr($info) {
    global $mya;
    
    $this->tidValue = $info['tid'];
    $this->dateValue = strftime('%m/%d/%y', $info['created']);
    $this->runBalance = u\fmtAmt($info['balance'], '');

    $class = "row txRow ";
    $class .= 'page-' . floor($this->count / MIN_TX_ROWS);
    $class .= ' PAGE-' . floor($this->count / NORMAL_TX_ROWS);
    $this->body .= "<tbody class=\"$class\">\n";
    $url = "BASE_URL?xid=&do=no";
    $xid = $info['xid'];

    // I am payee and amount > 0 or I am payer and amount < 0
    $reallyToMe = $info['myAmount'] > 0;

    if ((($mya->can($reallyToMe ? B_BUY : B_SELL) and !$info['banking']) or $mya->superAdmin) and !$info['isReversed'] and !$info['isDisputed']) {
      $this->buttons = w\btn("$this->baseUrl&xid=$xid&do=no", ' X ', 'primary', 'xs', ['title'=>t('Reverse')]);
    } else {
      $this->buttons = '';
    }
    $pageClasses = 'page-' . floor($this->count / MIN_TX_ROWS) . ' PAGE-' . floor($this->count / NORMAL_TX_ROWS);
    $disputedClass = ($info['isDisputed']) ? ' disputed' : '';
    $this->body .= <<<EOF
      <div class="row txRow $pageClasses$disputedClass">
        <div class="sepRow">
          <div class="separator"></div>
          <div class="sepBlank"></div>
        </div>
EOF;
  }

  /**
   * Called for each entry of a transaction.
   * @param assoc $info: all of the data for this entry (includes transaction data)
   */
  public function processEntry($info) {
    if (in_array($info['uid'], $this->uids)) return;
    extract(just('name description amount', $info));
    $amount = u\fmtAmt(- $amount, '');

    $this->body .= <<<EOF
<div class="txentry">
  <div class="tid-date col-xs-2">
    <div class="tid col-sm-5">$this->tidValue</div>
    <div class="date col-sm-7">$this->dateValue</div>
  </div>
  <div class="name-purpose col-xs-6">
    <div class="name col-sm-6">$name</div>
    <div class="purpose col-sm-6">$description</div>
  </div>
  <div class="amount-reward col-xs-3">
    <div class="amount col-sm-5">$amount</div>
    <div class="runBalance col-sm-7">$this->runBalance</div>
  </div>
  <div class="buttons col-xs-1">$this->buttons</div>
</div>
EOF;
/*     $this->body .= <<<EOF */
/* <tr> */
/*   <div class="tid col-sm-5">$this->tidValue</div> */
/*   <div class="date col-sm-7">$this->dateValue</div> */
/*   <div class="name col-sm-6">$name</div> */
/*   <div class="purpose col-sm-6">$description</div> */
/*   <div class="amount col-sm-5">$amount</div> */
/*   <div class="runBalance col-sm-7">$this->runBalance</div> */
/*   <div class="buttons col-xs-1">$buttons</div> */
/* </tr> */
/* EOF; */

    $this->tidValue = '';
    $this->dateValue = '';
    $this->runBalance = '';
    $this->buttons = '';
  }

  /**
   * Called after each transaction.
   * @param assoc $info: all of the data for this entry (includes transaction data)
   */
  public function txnFtr($info) {
    $this->body .= "</div>\n";
    $this->count += 1;
  }

  /**
   * Called after the last transaction.
   */
  public function ftr() {
    if ($this->count < 1) {
      $this->body .= '<div><div colspan=6>' . t('no txs') . '</div></div>';
    }
    $this->body .= "</div>\n</div>\n";
  }

  /**
   * Get the built HTML
   */
  public function getBody() {
    return w\item($this->body);
  }
}
